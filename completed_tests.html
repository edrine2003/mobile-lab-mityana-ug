<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Completed Results | Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  padding: 20px;
}
.result-card {
  background: #fff;
  padding: 15px;
  margin: 15px 0;
  border-radius: 6px;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 8px;
}
th, td {
  border: 1px solid #ddd;
  padding: 6px;
}
th {
  background: #eee;
}
input {
  width: 100%;
  padding: 4px;
  box-sizing: border-box;
}
button {
  margin-right: 5px;
  padding: 6px 10px;
  cursor: pointer;
}
</style>
</head>

<body>

<h2>Completed Test Results (Admin)</h2>
<button id="logoutBtn">Logout</button>
<div id="resultsContainer">Loadingâ€¦</div>

<script>
/* ðŸ”¥ Firebase Init */
firebase.initializeApp({
  apiKey: "AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY",
  authDomain: "mobile-lab-mityana-aeae2.firebaseapp.com",
  projectId: "mobile-lab-mityana-aeae2"
});

const auth = firebase.auth();
const db = firebase.firestore();
const box = document.getElementById("resultsContainer");

/* ðŸ” Auth + Admin Check */
auth.onAuthStateChanged(async user => {
  if (!user) return location.href = "login.html";

  const u = await db.collection("users").doc(user.uid).get();
  if (!u.exists || u.data().role !== "admin") {
    await auth.signOut();
    return location.href = "login.html";
  }

  loadResults();
});

/* Logout */
document.getElementById("logoutBtn").onclick = () => auth.signOut();

/* ðŸ” Normalize results for table display */
function normalizeResults(data){
  let r = data.results || data.tests || {};
  let normalized = {};

  Object.keys(r).forEach(test => {
    if (typeof r[test] === "object" && !Array.isArray(r[test])) {
      normalized[test] = {};
      Object.keys(r[test]).forEach(param => {
        const v = r[test][param];
        normalized[test][param] =
          typeof v === "object"
            ? { value: v.value || "", units: v.units || "" }
            : { value: v, units: "" };
      });
    }
  });

  if (!Object.keys(normalized).length && Object.keys(r).length) {
    normalized["General Test"] = {};
    Object.keys(r).forEach(p => {
      normalized["General Test"][p] = { value: r[p], units: "" };
    });
  }

  return normalized;
}

/* ðŸ“¥ Load completed results */
async function loadResults() {
  box.innerHTML = "";

  const snap = await db.collection("orders")
    .where("status", "==", "completed")
    .get();

  if (snap.empty) {
    box.innerHTML = "<p>No completed results</p>";
    return;
  }

  for (const o of snap.docs) {
    const rs = await db.collection("results").doc(o.id).get();
    if (!rs.exists) continue;

    const data = rs.data();
    const results = normalizeResults(data);

    const card = document.createElement("div");
    card.className = "result-card";

    // Show patient name if exists, else fallback to email
    const patientName = data.patientName || data.patientEmail || "N/A";

    let html = `<h4>Order: ${o.id}</h4>
                <p>Patient: ${patientName}</p>`;

    Object.keys(results).forEach(test => {
      html += `<h4>${test}</h4><table>
      <tr><th>Parameter</th><th>Units</th><th>Value</th></tr>`;
      Object.keys(results[test]).forEach(param => {
        const r = results[test][param];
        html += `<tr>
          <td>${param}</td>
          <td>${r.units}</td>
          <td><input data-test="${test}" data-param="${param}" data-units="${r.units}" value="${r.value}"></td>
        </tr>`;
      });
      html += "</table>";
    });

    html += `
      <button class="save">Update</button>
      <button class="pdf">PDF</button>
      <button class="del">Delete</button>
    `;

    card.innerHTML = html;
    box.appendChild(card);

    /* âœ Update results */
    card.querySelector(".save").onclick = async () => {
      let updated = {};
      card.querySelectorAll("input").forEach(i => {
        updated[i.dataset.test] ??= {};
        updated[i.dataset.test][i.dataset.param] = {
          value: i.value,
          units: i.dataset.units
        };
      });

      await db.collection("results").doc(o.id).update({
        results: updated,
        patientEmail: data.patientEmail.toLowerCase(),
        patientName: patientName
      });

      alert("Updated successfully!");
    };

    /* ðŸ“„ PDF download */
    card.querySelector(".pdf").onclick = () => {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      let y = 10;
      pdf.text(`Order ${o.id}`, 10, y); y += 8;
      pdf.text(`Patient: ${patientName}`, 10, y); y += 8;

      Object.keys(results).forEach(test => {
        pdf.text(test, 10, y); y += 6;
        Object.keys(results[test]).forEach(param => {
          const r = results[test][param];
          pdf.text(`${param}: ${r.value} ${r.units}`, 10, y); y += 6;
        });
      });

      pdf.save(`Result_${o.id}.pdf`);
    };

    /* ðŸ—‘ Delete result */
    card.querySelector(".del").onclick = async () => {
      if (!confirm("Delete this result?")) return;
      await db.collection("results").doc(o.id).delete();
      await db.collection("orders").doc(o.id).update({ status: "ongoing" });
      card.remove();
    };
  }
}
</script>

</body>
</html>
