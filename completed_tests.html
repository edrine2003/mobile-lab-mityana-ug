<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Completed Results | Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
.result-card{background:#fff;padding:15px;margin:15px 0;border-radius:6px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:6px}
th{background:#eee}
input{width:100%}
button{margin-right:5px;padding:6px 10px}
</style>
</head>

<body>

<h2>Completed Test Results (Admin)</h2>
<button id="logoutBtn">Logout</button>
<div id="resultsContainer">Loadingâ€¦</div>

<script>
/* ðŸ”¥ Firebase */
firebase.initializeApp({
  apiKey: "AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY",
  authDomain: "mobile-lab-mityana-aeae2.firebaseapp.com",
  projectId: "mobile-lab-mityana-aeae2",
  storageBucket: "mobile-lab-mityana-aeae2.appspot.com",
  appId: "1:624002906588:web:08b4259f90ffa9adad7719"
});

const auth = firebase.auth();
const db = firebase.firestore();
const box = document.getElementById("resultsContainer");

/* ðŸ” Auth */
auth.onAuthStateChanged(async user=>{
  if(!user) return location.href="login.html";
  const u = await db.collection("users").doc(user.uid).get();
  if(!u.exists || u.data().role!=="admin"){
    await auth.signOut();
    return location.href="login.html";
  }
  loadResults();
});

document.getElementById("logoutBtn").onclick=()=>auth.signOut();

/* ðŸ” NORMALIZE RESULTS FORMAT */
function normalizeResults(data){
  let r = data.results || data.tests || {};
  let normalized = {};

  Object.keys(r).forEach(test=>{
    if(typeof r[test] === "object" && !Array.isArray(r[test])){
      normalized[test] = {};
      Object.keys(r[test]).forEach(param=>{
        const v = r[test][param];
        normalized[test][param] =
          typeof v === "object"
            ? { value:v.value||"", units:v.units||"" }
            : { value:v, units:"" };
      });
    }
  });

  if(!Object.keys(normalized).length && Object.keys(r).length){
    normalized["General Test"] = {};
    Object.keys(r).forEach(p=>{
      normalized["General Test"][p]={ value:r[p], units:"" };
    });
  }

  return normalized;
}

/* ðŸ“¥ LOAD RESULTS */
async function loadResults(){
  box.innerHTML="";
  const snap = await db.collection("orders")
    .where("status","==","completed")
    .get();

  if(snap.empty){
    box.innerHTML="<p>No completed results</p>";
    return;
  }

  for(const o of snap.docs){
    const rs = await db.collection("results").doc(o.id).get();
    if(!rs.exists) continue;

    let data = rs.data();
    let results = normalizeResults(data);

    const card = document.createElement("div");
    card.className="result-card";

    let html = `<h4>Order: ${o.id}</h4>
                <p>Patient: ${data.patient_email||"N/A"}</p>`;

    Object.keys(results).forEach(test=>{
      html+=`<h4>${test}</h4><table>
      <tr><th>Parameter</th><th>Units</th><th>Value</th></tr>`;
      Object.keys(results[test]).forEach(p=>{
        const v = results[test][p];
        html+=`
        <tr>
          <td>${p}</td>
          <td>${v.units}</td>
          <td><input data-test="${test}" data-param="${p}" data-units="${v.units}" value="${v.value}"></td>
        </tr>`;
      });
      html+="</table>";
    });

    html+=`
      <button class="save">Update</button>
      <button class="pdf">PDF</button>
      <button class="del">Delete</button>
    `;

    card.innerHTML=html;
    box.appendChild(card);

    /* âœ UPDATE */
    card.querySelector(".save").onclick=async()=>{
      let updated={};
      card.querySelectorAll("input").forEach(i=>{
        updated[i.dataset.test]??={};
        updated[i.dataset.test][i.dataset.param]={
          value:i.value,
          units:i.dataset.units
        };
      });
      await db.collection("results").doc(o.id).update({results:updated});
      results=updated;
      alert("Updated");
    };

    /* ðŸ“„ PDF */
    card.querySelector(".pdf").onclick=()=>{
      const {jsPDF}=window.jspdf;
      const pdf=new jsPDF();
      let y=10;
      pdf.text(`Order ${o.id}`,10,y);y+=8;
      Object.keys(results).forEach(t=>{
        pdf.text(t,10,y);y+=6;
        Object.keys(results[t]).forEach(p=>{
          const r=results[t][p];
          pdf.text(`${p}: ${r.value} ${r.units}`,10,y);
          y+=6;
        });
      });
      pdf.save(`Result_${o.id}.pdf`);
    };

    /* ðŸ—‘ DELETE */
    card.querySelector(".del").onclick=async()=>{
      if(!confirm("Delete result?"))return;
      await db.collection("results").doc(o.id).delete();
      await db.collection("orders").doc(o.id).update({status:"ongoing"});
      card.remove();
    };
  }
}
</script>

</body>
</html>
