<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard â€“ Mobile Lab Mityana</title>
<meta name="description" content="Admin: Manage lab orders, upload results, send WhatsApp updates">
<meta name="theme-color" content="#0ea5e9">

<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon-192.png">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f4f7fa;color:#0f172a;}
.container{max-width:900px;margin:18px auto;padding:16px;}
.header{background:linear-gradient(135deg,#0ea5e9,#14b8a6);color:#fff;padding:16px;text-align:center;border-radius:18px 18px 0 0;margin-bottom:12px;}
.card{background:#fff;border-radius:18px;padding:16px;margin-bottom:12px;box-shadow:0 8px 20px rgba(0,0,0,0.06);}
textarea,input,select{width:100%;padding:8px;margin:6px 0 12px;border-radius:12px;border:1px solid #cbd5e1;}
button{padding:10px;background:linear-gradient(135deg,#0ea5e9,#14b8a6);color:#fff;border:none;border-radius:12px;cursor:pointer;margin-top:6px;width:100%;}
button:hover{filter:brightness(0.95);}
.status{padding:4px 8px;border-radius:8px;font-size:13px;color:#fff;font-weight:700;}
.status.Pending{background:#f97316;}
.status.Completed{background:#16a34a;}
.status.Lacking{background:#dc2626;}
</style>
</head>
<body>
<div class="container">
  <div class="header"><h2>ðŸ§ª Admin Dashboard</h2></div>
  <div id="ordersContainer"></div>
  <button id="logoutBtn">Logout</button>
</div>

<script>
const firebaseConfig = { apiKey:"AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY", authDomain:"mobile-lab-mityana-aeae2.firebaseapp.com", projectId:"mobile-lab-mityana-aeae2" };
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const adminWhatsApp="256750992939";
const ordersContainer=document.getElementById("ordersContainer");

auth.onAuthStateChanged(async(user)=>{
  if(!user){window.location.href="login.html";return;}
  const doc=await db.collection("users").doc(user.uid).get();
  const email = doc.exists ? doc.data().email : user.email;
  if(email!=="edrinehero@gmail.com"){ alert("Access denied"); window.location.href="index.html"; return; }

  // Fetch all orders
  db.collection("orders").orderBy("created_at","desc").onSnapshot(snapshot=>{
    ordersContainer.innerHTML="";
    if(snapshot.empty){ ordersContainer.innerHTML="<p>No orders yet</p>"; return; }
    snapshot.forEach(doc=>{
      const o=doc.data();
      const card=document.createElement("div"); card.className="card";
      card.innerHTML=`
        <p><b>Order ID:</b> ${o.order_id}</p>
        <p><b>Patient:</b> ${o.name} | ${o.phone}</p>
        <p><b>Tests:</b><br>${o.tests.replace(/\n/g,"<br>")}</p>
        <p><b>Total:</b> ${o.total}</p>
        <p><b>Status:</b> <span class="status ${o.status||'Pending'}">${o.status||'Pending'}</span></p>
        <label>Results / Notes</label>
        <textarea id="res_${doc.id}" placeholder="Enter results here">${o.results||''}</textarea>
        <select id="status_${doc.id}">
          <option value="Pending" ${o.status==="Pending"?"selected":""}>Pending</option>
          <option value="Completed" ${o.status==="Completed"?"selected":""}>Completed</option>
          <option value="Lacking" ${o.status==="Lacking"?"selected":""}>Lacking</option>
        </select>
        <button onclick="updateOrder('${doc.id}','${o.phone}','${o.name}')">ðŸ’¾ Update & Send WhatsApp</button>
      `;
      ordersContainer.appendChild(card);
    });
  });
});

async function updateOrder(docId,phone,name){
  const results = document.getElementById(`res_${docId}`).value;
  const status = document.getElementById(`status_${docId}`).value;
  await db.collection("orders").doc(docId).update({ results,status });
  const waText=`Hello ${name},\nYour lab results are ready.\nStatus: ${status}\nResults:\n${results}`;
  window.open(`https://wa.me/256${phone.replace(/^0/,'')}?text=${encodeURIComponent(waText)}`);
  alert("Updated & WhatsApp opened!");
}

document.getElementById("logoutBtn").addEventListener("click", async()=>{await auth.signOut();window.location.href="login.html";});
</script>
</body>
</html>
