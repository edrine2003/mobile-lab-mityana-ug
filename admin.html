<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard â€“ Mobile Lab Mityana</title>

<meta name="description" content="Upload lab results and manage patient requests.">
<meta name="theme-color" content="#0ea5e9">

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {font-family: Arial, sans-serif; margin:0; padding:0; background:#f1f5f9; color:#0f172a;}
.container {max-width:900px; margin:20px auto; padding:16px;}
.header {background: linear-gradient(135deg,#0ea5e9,#14b8a6); color:#fff; padding:18px; text-align:center; border-radius:12px;}
.header h2 {margin:0;}
.logoutBtn {background:#ef4444; color:#fff; padding:12px 18px; border:none; border-radius:999px; font-weight:800; cursor:pointer; float:right; margin-top:-50px;}
.section {margin-top:20px;}
.section h3 {margin-bottom:12px;}
input, textarea {width:100%; padding:10px; margin:6px 0 12px; border-radius:12px; border:1px solid rgba(15,23,42,0.12);}
button {background: linear-gradient(135deg,#0ea5e9,#14b8a6); color:#fff; padding:12px; border:none; border-radius:12px; cursor:pointer; font-weight:800;}
button:hover {filter:brightness(0.95);}
.result-item, .request-item {background:#fff; padding:12px; border-radius:12px; border:1px solid rgba(15,23,42,0.12); margin-bottom:12px;}
.badge {display:inline-block; background:#ef4444; color:#fff; border-radius:999px; padding:4px 10px; font-size:12px; font-weight:700; margin-left:6px;}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h2>ðŸ§ª Admin Dashboard</h2>
    <p>Upload lab results and manage patient requests.</p>
    <button class="logoutBtn" id="logoutBtn">Logout</button>
  </div>

  <!-- Patient Requests -->
  <div class="section">
    <h3>ðŸ“¥ Patient Requests <span id="requestCount" class="badge">0</span></h3>
    <div id="requestsContainer">
      Loading requests...
    </div>
  </div>

  <!-- Upload Lab Result -->
  <div class="section">
    <h3>ðŸ“¤ Upload Lab Result</h3>
    <input id="patientEmail" placeholder="Patient Email">
    <textarea id="resultText" placeholder="Enter test results here..."></textarea>
    <button id="uploadResultBtn">Upload Result</button>
    <p id="uploadConfirmation"></p>
  </div>
</div>

<script>
// ðŸ”¹ Firebase init
const firebaseConfig = {
  apiKey: "AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY",
  authDomain: "mobile-lab-mityana-aeae2.firebaseapp.com",
  projectId: "mobile-lab-mityana-aeae2",
  storageBucket: "mobile-lab-mityana-aeae2.firebasestorage.app",
  messagingSenderId: "624002906588",
  appId: "1:624002906588:web:08b4259f90ffa9adad7719",
};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

// ðŸ”¹ Require admin login
auth.onAuthStateChanged(async user=>{
  if(!user || user.email !== "edrinehero@gmail.com"){
    window.location.href = "login.html";
    return;
  }

  // Show all patient requests
  const requestsContainer = document.getElementById("requestsContainer");
  const requestCountBadge = document.getElementById("requestCount");

  const loadRequests = async () => {
    try {
      const snapshot = await db.collection("orders").orderBy("created_at", "desc").get();
      requestsContainer.innerHTML = "";
      requestCountBadge.innerText = snapshot.size;

      if(snapshot.empty){
        requestsContainer.innerHTML = "<p>No patient requests yet.</p>";
        return;
      }

      snapshot.forEach(doc=>{
        const data = doc.data();
        const div = document.createElement("div");
        div.className = "request-item";
        div.innerHTML = `
          <b>Order ID:</b> ${data.order_id}<br>
          <b>Name:</b> ${data.name}<br>
          <b>Email:</b> ${data.email}<br>
          <b>Phone:</b> ${data.phone}<br>
          <b>Tests:</b> ${data.tests}<br>
          <b>Total:</b> ${data.total}<br>
          <b>Payment:</b> ${data.payment}<br>
          <i>Submitted: ${data.created_at}</i>
        `;
        requestsContainer.appendChild(div);
      });
    } catch(err){
      console.error(err);
      requestsContainer.innerHTML = "<p>Failed to load requests.</p>";
    }
  };

  loadRequests();

  // ðŸ”¹ Upload lab result
  const uploadBtn = document.getElementById("uploadResultBtn");
  uploadBtn.addEventListener("click", async ()=>{
    const email = document.getElementById("patientEmail").value.trim();
    const resultText = document.getElementById("resultText").value.trim();
    const confirmP = document.getElementById("uploadConfirmation");

    if(!email || !resultText){
      confirmP.innerText = "Please enter patient email and result text.";
      return;
    }

    try {
      await db.collection("results").add({
        patientEmail: email,
        resultText: resultText,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      confirmP.innerText = "âœ… Lab result uploaded successfully!";
      document.getElementById("patientEmail").value = "";
      document.getElementById("resultText").value = "";
    } catch(err){
      console.error(err);
      confirmP.innerText = "âŒ Failed to upload result.";
    }
  });

});

// ðŸ”¹ Logout
document.getElementById("logoutBtn").addEventListener("click", async ()=>{
  await auth.signOut();
  window.location.href = "login.html";
});
</script>

</body>
</html>
