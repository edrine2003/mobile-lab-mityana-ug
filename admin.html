<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ§ª Admin Dashboard â€“ Mobile Lab</title>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{font-family:Arial,sans-serif;margin:0;padding:16px;background:#f1f5f9;color:#0f172a;}
h2{margin:0 0 16px;}
#logoutBtn{position:fixed;top:16px;right:16px;background:#ef4444;color:#fff;padding:12px 16px;border:none;border-radius:999px;cursor:pointer;}
#ordersCounter{font-weight:bold;margin-bottom:12px;}
.order-card{border:1px solid #cbd5e1;border-radius:12px;padding:12px;margin-bottom:12px;background:#fff;}
.order-card h4{margin:0 0 6px;font-size:14px;color:#0369a1;}
.order-card p{margin:2px 0;font-size:13px;}
.results-table{width:100%;border-collapse:collapse;margin:8px 0;}
.results-table th, .results-table td{border:1px solid #cbd5e1;padding:6px;font-size:13px;}
.results-table th{background:#e0f2fe;}
button{margin-top:6px;padding:8px 12px;border:none;background:#0ea5e9;color:#fff;border-radius:12px;cursor:pointer;}
button:hover{filter:brightness(0.95);}
select{padding:4px;border-radius:6px;border:1px solid #cbd5e1;}
</style>
</head>
<body>

<button id="logoutBtn">Logout</button>
<h2>ðŸ§ª Admin Dashboard</h2>
<div id="ordersCounter">Loading requests...</div>
<div id="ordersContainer"></div>

<script>
// ðŸ”¹ Firebase init
const firebaseConfig = {
  apiKey: "AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY",
  authDomain: "mobile-lab-mityana-aeae2.firebaseapp.com",
  projectId: "mobile-lab-mityana-aeae2",
  storageBucket: "mobile-lab-mityana-aeae2.firebasestorage.app",
  messagingSenderId: "624002906588",
  appId: "1:624002906588:web:08b4259f90ffa9adad7719",
};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

const ordersContainer = document.getElementById("ordersContainer");
const ordersCounter = document.getElementById("ordersCounter");

// ðŸ”¹ Require admin login
auth.onAuthStateChanged(async user => {
  if(!user || user.email !== "edrinehero@gmail.com"){
    alert("Access denied. Admin only.");
    window.location.href = "login.html";
    return;
  }

  loadOrders();
});

// ðŸ”¹ Logout
document.getElementById("logoutBtn").addEventListener("click", async ()=>{
  await auth.signOut();
  window.location.href = "login.html";
});

// ðŸ”¹ Generate editable tables for ALL tests
function generateResultsTable(testName){
  let html = `<h4>${testName}</h4><table class="results-table"><thead><tr><th>Parameter</th><th>Units</th><th>Result</th></tr></thead><tbody>`;

  switch(testName){
    case "Urinalysis":
      html += `
<tr><td>Macroscopy</td><td></td><td contenteditable="true"></td></tr>
<tr><td>UROBILINOGEN</td><td></td><td contenteditable="true"></td></tr>
<tr><td>BILIRUBIN</td><td></td><td contenteditable="true"></td></tr>
<tr><td>SPECIFIC GRAVITY</td><td></td><td contenteditable="true"></td></tr>
<tr><td>pH</td><td></td><td contenteditable="true"></td></tr>
<tr><td>NITRITES</td><td></td><td contenteditable="true"></td></tr>
<tr><td>GLUCOSE</td><td><select><option>mmol/L</option><option>mg/dL</option></select></td><td contenteditable="true"></td></tr>
<tr><td>PROTEINS</td><td></td><td contenteditable="true"></td></tr>
<tr><td>KETONES</td><td></td><td contenteditable="true"></td></tr>
<tr><td>LEUKOCYTES</td><td></td><td contenteditable="true"></td></tr>
<tr><td>RBCs</td><td></td><td contenteditable="true"></td></tr>
<tr><td>Microscopy</td><td></td><td contenteditable="true"></td></tr>
      `;
      break;

    case "HIV":
      html += `<tr><td>HIV Result</td><td></td><td contenteditable="true">Negative / Positive / Inconclusive</td></tr>`;
      break;

    case "Hepatitis B":
      html += `<tr><td>HBsAg</td><td></td><td contenteditable="true">Negative / Positive / Inconclusive</td></tr>`;
      break;

    case "Hepatitis C":
      html += `<tr><td>HCV Ab</td><td></td><td contenteditable="true">Negative / Positive / Inconclusive</td></tr>`;
      break;

    case "RPR / Syphilis":
      html += `<tr><td>RPR Result</td><td></td><td contenteditable="true">Negative / Positive / Inconclusive</td></tr>`;
      break;

    case "CBC - Complete Blood Count":
      html += `
<tr><td>WBC</td><td>10^3/ÂµL</td><td contenteditable="true"></td></tr>
<tr><td>RBC</td><td>10^6/ÂµL</td><td contenteditable="true"></td></tr>
<tr><td>Hemoglobin</td><td>g/dL</td><td contenteditable="true"></td></tr>
<tr><td>Hematocrit</td><td>%</td><td contenteditable="true"></td></tr>
<tr><td>Platelets</td><td>10^3/ÂµL</td><td contenteditable="true"></td></tr>
      `;
      break;

    case "Blood Glucose":
      html += `<tr><td>Glucose</td><td><select><option>mmol/L</option><option>mg/dL</option></select></td><td contenteditable="true"></td></tr>`;
      break;

    case "Blood Grouping":
      html += `<tr><td>Blood Group</td><td></td><td contenteditable="true"></td></tr>`;
      break;

    case "Bleeding & Clotting Test":
      html += `
<tr><td>PT</td><td>sec</td><td contenteditable="true"></td></tr>
<tr><td>APTT</td><td>sec</td><td contenteditable="true"></td></tr>
<tr><td>INR</td><td></td><td contenteditable="true"></td></tr>
      `;
      break;

    case "Lipid Profile":
      html += `
<tr><td>Total Cholesterol</td><td>mg/dL</td><td contenteditable="true"></td></tr>
<tr><td>HDL</td><td>mg/dL</td><td contenteditable="true"></td></tr>
<tr><td>LDL</td><td>mg/dL</td><td contenteditable="true"></td></tr>
<tr><td>Triglycerides</td><td>mg/dL</td><td contenteditable="true"></td></tr>
      `;
      break;

    case "Liver Function Test (LFT)":
      html += `
<tr><td>ALT</td><td>U/L</td><td contenteditable="true"></td></tr>
<tr><td>AST</td><td>U/L</td><td contenteditable="true"></td></tr>
<tr><td>ALP</td><td>U/L</td><td contenteditable="true"></td></tr>
<tr><td>Bilirubin Total</td><td>mg/dL</td><td contenteditable="true"></td></tr>
<tr><td>Bilirubin Direct</td><td>mg/dL</td><td contenteditable="true"></td></tr>
      `;
      break;

    case "Kidney Function Test (RFT)":
      html += `
<tr><td>Urea</td><td>mg/dL</td><td contenteditable="true"></td></tr>
<tr><td>Creatinine</td><td>mg/dL</td><td contenteditable="true"></td></tr>
<tr><td>Electrolytes Na+</td><td>mmol/L</td><td contenteditable="true"></td></tr>
<tr><td>Electrolytes K+</td><td>mmol/L</td><td contenteditable="true"></td></tr>
      `;
      break;

    case "PSA":
      html += `<tr><td>PSA</td><td>ng/mL</td><td contenteditable="true"></td></tr>`;
      break;

    case "HCG Blood":
      html += `<tr><td>hCG</td><td>mIU/mL</td><td contenteditable="true"></td></tr>`;
      break;

    case "Sickling Test":
      html += `<tr><td>Sickling Test Result</td><td></td><td contenteditable="true"></td></tr>`;
      break;

    case "DNA":
      html += `<tr><td>DNA Test Result</td><td></td><td contenteditable="true"></td></tr>`;
      break;

    case "Gonorrhea Test":
      html += `<tr><td>Gonorrhea Result</td><td></td><td contenteditable="true"></td></tr>`;
      break;

    case "Chlamydia Test":
      html += `<tr><td>Chlamydia Result</td><td></td><td contenteditable="true"></td></tr>`;
      break;

    case "Brucella Test":
      html += `<tr><td>Brucella Result</td><td></td><td contenteditable="true"></td></tr>`;
      break;

    case "Urinalysis":
      html += `
<tr><td>Urinalysis Full</td><td></td><td contenteditable="true"></td></tr>
      `;
      break;

    case "Urinalysis":
      html += `<tr><td>Urinalysis Full</td><td></td><td contenteditable="true"></td></tr>`;  
      break;

    case "Pregnancy Test (hCG)":
      html += `<tr><td>Pregnancy Test Result</td><td></td><td contenteditable="true">Negative / Positive</td></tr>`;
      break;

    case "High Vaginal Swab":
      html += `<tr><td>HVS Result</td><td></td><td contenteditable="true"></td></tr>`;
      break;

    case "High Vaginal Swab C&S":
      html += `<tr><td>HVS C&S Result</td><td></td><td contenteditable="true"></td></tr>`;
      break;

    case "Gram Staining":
      html += `<tr><td>Gram Staining Result</td><td></td><td contenteditable="true"></td></tr>`;
      break;

    case "Widal Serum":
      html += `<tr><td>Widal Result</td><td></td><td contenteditable="true"></td></tr>`;
      break;

    case "Rheumatoid Factor":
      html += `<tr><td>Rheumatoid Factor Result</td><td></td><td contenteditable="true"></td></tr>`;
      break;

    default:
      html += `<tr><td>${testName}</td><td></td><td contenteditable="true"></td></tr>`;
  }

  html += "</tbody></table>";
  return html;
}

// ðŸ”¹ Load orders
async function loadOrders(){
  try{
    const snapshot = await db.collection("orders").orderBy("created_at","desc").get();
    const orders = snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
    ordersCounter.innerText = `ðŸ“¥ Total Requests: ${orders.length}`;

    if(orders.length === 0){
      ordersContainer.innerHTML = "<p>No requests yet.</p>";
      return;
    }

    ordersContainer.innerHTML = "";
    orders.forEach(order=>{
      const card = document.createElement("div");
      card.className = "order-card";

      let tablesHtml = "";
      order.tests.split("\n").forEach(test=>{
        tablesHtml += generateResultsTable(test);
      });

      card.innerHTML = `
        <h4>Order ID: ${order.order_id}</h4>
        <p><b>Name:</b> ${order.name} | <b>Phone:</b> ${order.phone}</p>
        <p><b>Age:</b> ${order.age} | <b>Sex:</b> ${order.sex}</p>
        <p><b>Tests:</b> ${order.tests}</p>
        <p><b>Total:</b> ${order.total}</p>
        <p><b>Payment:</b> ${order.payment}</p>
        <p><b>Location:</b> ${order.location}</p>
        <p><b>Notes:</b> ${order.notes}</p>
        ${tablesHtml}
        <button>Upload Results</button>
      `;

      const btn = card.querySelector("button");

      btn.addEventListener("click", async ()=>{
        const resultsObj = {};
        const tables = card.querySelectorAll("table.results-table");
        tables.forEach(table=>{
          const testName = table.previousElementSibling.innerText;
          resultsObj[testName] = {};
          table.querySelectorAll("tbody tr").forEach(row=>{
            const param = row.cells[0].innerText;
            const unit = row.cells[1].querySelector("select")?.value || row.cells[1].innerText;
            const value = row.cells[2].innerText.trim();
            resultsObj[testName][param] = {unit,value};
          });
        });

        await db.collection("results").doc(order.id).set({
          order_id: order.order_id,
          patient_email: order.email,
          results: resultsObj,
          uploaded_at: new Date()
        });

        alert("âœ… Results uploaded successfully!");
      });

      ordersContainer.appendChild(card);
    });

  }catch(err){
    console.error("Failed to load requests:", err);
    ordersContainer.innerHTML = "<p>Failed to load requests.</p>";
  }
}
</script>
</body>
</html>
