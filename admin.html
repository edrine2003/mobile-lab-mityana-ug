<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ§ª Admin Dashboard â€“ Mobile Lab</title>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {
  font-family: Arial,sans-serif;
  margin:0;
  padding:16px;
  background:#f1f5f9;
  color:#0f172a;
}
h2 { margin:0 0 16px; }
#logoutBtn {
  position: fixed;
  top:16px;
  right:16px;
  background:#ef4444;
  color:#fff;
  padding:12px 16px;
  border:none;
  border-radius:999px;
  cursor:pointer;
}
#ordersCounter { font-weight:bold; margin-bottom:12px; }
.order-card {
  border:1px solid #cbd5e1;
  border-radius:12px;
  padding:12px;
  margin-bottom:12px;
  background:#fff;
}
.order-card h4 { margin:0 0 6px; font-size:14px; color:#0369a1; }
.order-card p { margin:2px 0; font-size:13px; }
table { width:100%; border-collapse:collapse; margin-top:8px; }
th,td { border:1px solid #cbd5e1; padding:6px; text-align:left; }
th { background:#e2e8f0; }
input.result-input, textarea.result-input {
  width:90%;
  border:1px solid #cbd5e1;
  border-radius:6px;
  padding:4px;
}
button.action-btn {
  margin-top:6px;
  margin-right:6px;
  padding:6px 12px;
  border:none;
  border-radius:12px;
  cursor:pointer;
}
button.upload { background:#0ea5e9; color:#fff; }
button.status { background:#22c55e; color:#fff; }
button.delete { background:#ef4444; color:#fff; }
button:hover { filter:brightness(0.95); }
</style>
</head>

<body>

<button id="logoutBtn">Logout</button>
<h2>ðŸ§ª Admin Dashboard</h2>
<div id="ordersCounter">Loading requests...</div>
<div id="ordersContainer"></div>

<script>
// ðŸ”¹ Firebase init
const firebaseConfig = {
  apiKey: "AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY",
  authDomain: "mobile-lab-mityana-aeae2.firebaseapp.com",
  projectId: "mobile-lab-mityana-aeae2",
  storageBucket: "mobile-lab-mityana-aeae2.firebasestorage.app",
  messagingSenderId: "624002906588",
  appId: "1:624002906588:web:08b4259f90ffa9adad7719",
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

const ordersContainer = document.getElementById("ordersContainer");
const ordersCounter = document.getElementById("ordersCounter");

/* ---------------- ADMIN AUTH (ROLE BASED) ---------------- */
auth.onAuthStateChanged(async user => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  const userDoc = await db.collection("users").doc(user.uid).get();
  if (!userDoc.exists || userDoc.data().role !== "admin") {
    alert("Access denied. Admin only.");
    await auth.signOut();
    window.location.href = "login.html";
    return;
  }

  loadOrders();
});

/* ---------------- LOGOUT ---------------- */
document.getElementById("logoutBtn").addEventListener("click", async () => {
  await auth.signOut();
  window.location.href = "login.html";
});

/* ---------------- LOAD ORDERS ---------------- */
async function loadOrders() {
  try {
    const snapshot = await db.collection("orders").orderBy("created_at", "desc").get();
    const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    const today = new Date().toDateString();
    let todayOrders = 0;
    let todayRevenue = 0;

    orders.forEach(o => {
      if (o.created_at && o.created_at.toDate().toDateString() === today) {
        todayOrders++;
        todayRevenue += Number(o.total || 0);
      }
    });

    ordersCounter.innerText =
      `ðŸ“¥ Total: ${orders.length} | ðŸ“… Today: ${todayOrders} | ðŸ’° UGX ${todayRevenue}`;

    if (!orders.length) {
      ordersContainer.innerHTML = "<p>No requests yet.</p>";
      return;
    }

    ordersContainer.innerHTML = "";

    orders.forEach(order => {
      const card = document.createElement("div");
      card.className = "order-card";

      let html = `
        <h4>Order ID: ${order.order_id}</h4>
        <p><b>Name:</b> ${order.name} | <b>Phone:</b> ${order.phone}</p>
        <p><b>Age:</b> ${order.age} | <b>Sex:</b> ${order.sex}</p>
        <p><b>Tests:</b> ${order.tests}</p>
        <p><b>Total:</b> ${order.total}</p>
        <p><b>Status:</b> ${order.status || "Pending"}</p>
        <p><b>Payment:</b> ${order.payment}</p>
        <p><b>Location:</b> ${order.location}</p>
        <p><b>Notes:</b> ${order.notes}</p>
      `;

      html += `
        <button class="action-btn upload">Upload Results</button>
        <button class="action-btn status" data-status="Sample Collected">Sample Collected</button>
        <button class="action-btn status" data-status="In Lab">In Lab</button>
        <button class="action-btn status" data-status="Results Ready">Results Ready</button>
        <button class="action-btn delete">Delete Order</button>
      `;

      card.innerHTML = html;
      ordersContainer.appendChild(card);

      /* -------- STATUS UPDATE -------- */
      card.querySelectorAll(".status").forEach(btn => {
        btn.addEventListener("click", async () => {
          await db.collection("orders").doc(order.id).update({
            status: btn.dataset.status
          });
          alert("Status updated");
          loadOrders();
        });
      });

      /* -------- DELETE ORDER -------- */
      card.querySelector(".delete").addEventListener("click", async () => {
        if (!confirm("Delete this order?")) return;
        await db.collection("orders").doc(order.id).delete();
        await db.collection("results").doc(order.id).delete();
        card.remove();
      });

      /* -------- UPLOAD RESULTS -------- */
      card.querySelector(".upload").addEventListener("click", async () => {
        await db.collection("results").doc(order.id).set({
          order_id: order.order_id,
          uploaded_at: new Date()
        });

        await db.collection("orders").doc(order.id).update({
          status: "Results Ready"
        });

        alert("âœ… Results uploaded & status updated");
        loadOrders();
      });
    });

  } catch (err) {
    console.error(err);
    ordersContainer.innerHTML = "<p>Failed to load orders.</p>";
  }
}
</script>

</body>
</html>
