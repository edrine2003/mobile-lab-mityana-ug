<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üß™ Admin Dashboard ‚Äì Mobile Lab</title>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

<style>
body {
  font-family: 'Inter', sans-serif;
  margin: 0;
  padding: 16px;
  background: #f1f5f9;
  color: #0f172a;
}
h2 { margin: 0 0 16px; color:#0f172a; }
#logoutBtn {
  position: fixed; top:16px; right:16px;
  background:#ef4444; color:#fff;
  padding:12px 16px; border:none; border-radius:999px; cursor:pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
#logoutBtn:hover { filter: brightness(0.9); }

#ordersCounter { font-weight:700; margin-bottom:12px; font-size:16px; }

.order-card {
  border-radius:14px; padding:16px; margin-bottom:16px;
  background:#fff; box-shadow: 0 6px 16px rgba(0,0,0,0.08);
  transition: transform 0.15s;
}
.order-card:hover { transform: translateY(-2px); }

.order-card h4 { margin:0 0 8px; font-size:16px; color:#0369a1; }
.order-card p { margin:4px 0; font-size:14px; }

button {
  margin-top:8px; padding:10px 16px; border:none;
  border-radius:12px; cursor:pointer; font-weight:600;
  font-size:14px;
  transition: all 0.2s;
}
.upload-btn { background: #0ea5e9; color:#fff; }
.upload-btn:hover { filter: brightness(0.9); }
.delete-btn { background: #ef4444; color:#fff; margin-left:8px; }
.delete-btn:hover { filter: brightness(0.9); }

table {
  width:100%; border-collapse:collapse; margin:8px 0 16px;
}
th, td {
  border:1px solid #cbd5e1; padding:6px 8px; text-align:left;
}
th { background:#e2e8f0; font-weight:600; }
.result-input { width:95%; border:1px solid #cbd5e1; border-radius:6px; padding:4px; }

.message-box {
  padding:10px 14px; border-radius:12px; margin-top:8px;
  font-weight:600; display:none;
}
.success { background:#d1fae5; color:#065f46; }
.error { background:#fee2e2; color:#991b1b; }

@media(max-width:768px) {
  .order-card { padding:12px; }
  button { width:100%; margin-top:6px; }
}
</style>
</head>
<body>

<button id="logoutBtn">Logout</button>
<h2>üß™ Admin Dashboard</h2>
<div id="ordersCounter">Loading requests...</div>
<div id="ordersContainer"></div>

<script>
// Firebase init
const firebaseConfig = {
  apiKey: "AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY",
  authDomain: "mobile-lab-mityana-aeae2.firebaseapp.com",
  projectId: "mobile-lab-mityana-aeae2",
  storageBucket: "mobile-lab-mityana-aeae2.firebasestorage.app",
  messagingSenderId: "624002906588",
  appId: "1:624002906588:web:08b4259f90ffa9adad7719"
};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

const ordersContainer = document.getElementById("ordersContainer");
const ordersCounter = document.getElementById("ordersCounter");

// All tests
const allTests = {
  "CBC - Complete Blood Count": [{param:"WBC", units:"x10^9/L", result:""},{param:"RBC", units:"x10^12/L", result:""},{param:"Hemoglobin", units:"g/dL", result:""},{param:"Hematocrit", units:"%", result:""},{param:"Platelets", units:"x10^9/L", result:""}],
  "Blood Glucose":[{param:"Glucose", units:"mmol/L or mg/dL", result:""}],
  "Blood Grouping":[{param:"Blood Group", units:"", result:""}],
  "Bleeding & Clotting Test":[{param:"Clotting Time", units:"min", result:""}],
  "Malaria (b/s)":[{param:"Result", units:"", result:""}],
  "Electrolytes":[{param:"Na+", units:"mmol/L", result:""},{param:"K+", units:"mmol/L", result:""},{param:"Cl-", units:"mmol/L", result:""}],
  "Lipid Profile":[{param:"Total Cholesterol", units:"mg/dL", result:""},{param:"HDL", units:"mg/dL", result:""},{param:"LDL", units:"mg/dL", result:""},{param:"Triglycerides", units:"mg/dL", result:""}],
  "Liver Function Test (LFT)":[{param:"ALT", units:"U/L", result:""},{param:"AST", units:"U/L", result:""},{param:"ALP", units:"U/L", result:""},{param:"Bilirubin Total", units:"mg/dL", result:""}],
  "Kidney Function Test (RFT)":[{param:"Urea", units:"mg/dL", result:""},{param:"Creatinine", units:"mg/dL", result:""}],
  "PSA":[{param:"PSA", units:"ng/mL", result:""}],
  "HCG Blood":[{param:"HCG", units:"mIU/mL", result:""}],
  "Sickling Test":[{param:"Result", units:"", result:""}],
  "DNA":[{param:"Result", units:"", result:""}],
  "HIV":[{param:"Result", units:"", result:""}],
  "Hepatitis B":[{param:"Result", units:"", result:""}],
  "Hepatitis C":[{param:"Result", units:"", result:""}],
  "RPR / Syphilis":[{param:"Result", units:"", result:""}],
  "Gonorrhea Test":[{param:"Result", units:"", result:""}],
  "Chlamydia Test":[{param:"Result", units:"", result:""}],
  "Brucella Test":[{param:"Result", units:"", result:""}],
  "Urinalysis":[
    {param:"Macroscopy", units:"", result:""},
    {param:"UROBILINOGEN", units:"", result:""},
    {param:"BILIRUBIN", units:"", result:""},
    {param:"SPECIFIC GRAVITY", units:"", result:""},
    {param:"pH", units:"", result:""},
    {param:"NITRITES", units:"", result:""},
    {param:"GLUCOSE", units:"mmol/L", result:""},
    {param:"PROTEINS", units:"", result:""},
    {param:"KETONES", units:"", result:""},
    {param:"LEUKOCYTES", units:"", result:""},
    {param:"RBCs", units:"", result:""},
    {param:"Microscopy", units:"", result:""}
  ],
  "Stool Analysis":[{param:"Result", units:"", result:""}],
  "H. Pylori Stool":[{param:"Result", units:"", result:""}],
  "H. Pylori Serum":[{param:"Result", units:"", result:""}],
  "Pregnancy Test (hCG)":[{param:"Result", units:"", result:""}],
  "High Vaginal Swab":[{param:"Result", units:"", result:""}],
  "High Vaginal Swab C&S":[{param:"Result", units:"", result:""}],
  "Gram Staining":[{param:"Result", units:"", result:""}],
  "Widal Serum":[{param:"Result", units:"", result:""}],
  "Rheumatoid Factor":[{param:"Result", units:"", result:""}]
};

// Admin login
auth.onAuthStateChanged(async user=>{
  if(!user || user.email!=="edrinehero@gmail.com"){
    alert("Access denied. Admin only.");
    window.location.href="login.html";
    return;
  }
  loadOrders();
});

document.getElementById("logoutBtn").addEventListener("click", async()=>{
  await auth.signOut();
  window.location.href="login.html";
});

async function loadOrders(){
  try{
    const snapshot = await db.collection("orders").orderBy("created_at","desc").get();
    const orders = snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
    ordersCounter.innerText = `üì• Total Requests: ${orders.length}`;
    if(!orders.length){ordersContainer.innerHTML="<p>No requests yet.</p>"; return;}
    ordersContainer.innerHTML="";

    orders.forEach(order=>{
      const card = document.createElement("div");
      card.className="order-card";

      let html=`<h4>Order ID: ${order.order_id}</h4>
      <p><b>Name:</b> ${order.name} | <b>Phone:</b> ${order.phone}</p>
      <p><b>Age:</b> ${order.age} | <b>Sex:</b> ${order.sex}</p>
      <p><b>Tests:</b> ${order.tests}</p>
      <p><b>Total:</b> ${order.total}</p>
      <p><b>Payment:</b> ${order.payment}</p>
      <p><b>Location:</b> ${order.location}</p>
      <p><b>Notes:</b> ${order.notes}</p>
      <div class="message-box" id="msgBox"></div>`;

      const selectedTests = order.tests.split("\n");
      selectedTests.forEach(testName=>{
        testName=testName.trim();
        if(allTests[testName]){
          html+=`<h4>${testName}</h4><table><tr><th>Parameter</th><th>Units</th><th>Result</th></tr>`;
          allTests[testName].forEach(row=>{
            html+=`<tr><td>${row.param}</td><td>${row.units}</td><td><input type="text" class="result-input" placeholder="Enter result"></td></tr>`;
          });
          html+="</table>";
        }else{
          html+=`<textarea class="result-input" placeholder="Enter result for ${testName}" rows="3"></textarea>`;
        }
      });

      html+=`<button class="upload-btn">Upload Results</button>
             <button class="delete-btn">Delete Order</button>`;

      card.innerHTML=html;

      const uploadBtn=card.querySelector(".upload-btn");
      const deleteBtn=card.querySelector(".delete-btn");
      const msgBox=card.querySelector("#msgBox");

      uploadBtn.addEventListener("click", async()=>{
        const inputs=card.querySelectorAll(".result-input");
        let results={};
        inputs.forEach((inp,idx)=>{results[idx]=inp.value.trim();});
        try{
          await db.collection("results").doc(order.id).set({
            order_id: order.order_id,
            patient_email: order.email,
            results: results,
            uploaded_at: new Date()
          });
          msgBox.innerText="‚úÖ Results uploaded successfully!";
          msgBox.className="message-box success";
        }catch(e){
          msgBox.innerText="‚ùå Failed to upload results.";
          msgBox.className="message-box error";
        }
      });

      deleteBtn.addEventListener("click", async()=>{
        if(!confirm("Are you sure you want to delete this order?")) return;
        try{
          await db.collection("orders").doc(order.id).delete();
          await db.collection("results").doc(order.id).delete();
          card.remove();
          ordersCounter.innerText=`üì• Total Requests: ${ordersContainer.childElementCount}`;
        }catch(e){
          msgBox.innerText="‚ùå Failed to delete order.";
          msgBox.className="message-box error";
        }
      });

      ordersContainer.appendChild(card);
    });

  }catch(err){console.error(err); ordersContainer.innerHTML="<p>Failed to load requests.</p>";}
}
</script>

</body>
</html>
