<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Patient Chat â€“ Mobile Lab Mityana</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  font-family: Arial;
  background: linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:white;
  margin:0;
  padding:20px;
}

h2{
  text-align:center;
}

.chat-box{
  background:white;
  color:black;
  height:60vh;
  overflow-y:auto;
  padding:15px;
  border-radius:15px;
  box-shadow:0 0 15px rgba(0,0,0,0.3);
}

input{
  width:70%;
  padding:12px;
  border-radius:10px;
  border:none;
  outline:none;
}

button{
  padding:12px 18px;
  background:#00c6ff;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-weight:bold;
}

.msg{
  margin:10px 0;
  padding:10px;
  border-radius:12px;
  max-width:70%;
}

.me{
  background:#c8f7c5;
  margin-left:auto;
  text-align:right;
}

.doctor{
  background:#f1f1f1;
}

.row{
  display:flex;
  gap:10px;
}
</style>
</head>

<body>

<h2>ðŸ§ª Mobile Lab Mityana â€“ Chat Doctor</h2>

<div class="chat-box" id="chatBox"></div>

<br>

<div class="row">
  <input type="text" id="messageInput" placeholder="Type message...">
  <button onclick="sendMessage()">Send</button>
</div>

<script>

const firebaseConfig = {
  apiKey: "AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY",
  authDomain: "mobile-lab-mityana-aeae2.firebaseapp.com",
  projectId: "mobile-lab-mityana-aeae2"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser;
let userData;
let chatId;
const adminUID = "DvmwZiewijWX8IBvKY5yF12ECqk1";

auth.onAuthStateChanged(async user=>{
  if(!user){
    alert("Login first");
    window.location.href="login.html";
    return;
  }

  currentUser = user;
  chatId = user.uid;

  try{
    const snap = await db.collection("users").doc(user.uid).get();
    userData = snap.exists ? snap.data() : {};
  }catch(err){
    console.error("User fetch error:",err);
  }

  loadMessages();
});

async function sendMessage(){

  const input = document.getElementById("messageInput");
  const text = input.value.trim();
  if(!text) return;

  try{
    await db.collection("chats")
      .doc(chatId)
      .collection("messages")
      .add({
        text: text,
        senderId: currentUser.uid,
        senderName: userData?.fullName || "Patient",
        patientId: currentUser.uid,
        receiverId: adminUID,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        status: "unread"
      });

    input.value="";
  }catch(err){
    console.error("Send error:",err);
    alert("Message failed. Check rules.");
  }
}

function loadMessages(){

  db.collection("chats")
    .doc(chatId)
    .collection("messages")
    .orderBy("timestamp")
    .onSnapshot(snapshot=>{

      const box = document.getElementById("chatBox");
      box.innerHTML="";

      snapshot.forEach(doc=>{
        const data = doc.data();

        const div = document.createElement("div");
        div.classList.add("msg");

        if(data.senderId === currentUser.uid){
          div.classList.add("me");
        } else {
          div.classList.add("doctor");
        }

        div.innerHTML = "<b>"+ (data.senderName || "User") +"</b><br>"+ data.text;
        box.appendChild(div);
      });

      box.scrollTop = box.scrollHeight;
    });
}

</script>

</body>
</html>
