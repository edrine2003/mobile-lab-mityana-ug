<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ðŸ’¬ Chat with Doctor â€“ Mobile Lab</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body{font-family:Arial,sans-serif;background:#f1f5f9;margin:0;padding:20px;}
h2{color:#0369a1;}
#chatBox{height:400px;overflow-y:auto;border:1px solid #ccc;background:#fff;padding:10px;border-radius:12px;margin-bottom:10px;}
.message{padding:6px 10px;margin:5px 0;border-radius:12px;max-width:70%;}
.sent{background:#0ea5e9;color:#fff;margin-left:auto;}
.received{background:#e2e8f0;margin-right:auto;}
#msgInput{width:80%;padding:8px;border-radius:8px;border:1px solid #ccc;}
#sendBtn{padding:8px 12px;border:none;border-radius:8px;background:#10b981;color:white;cursor:pointer;}
</style>
</head>
<body>

<h2>ðŸ’¬ Chat with Doctor</h2>
<div id="chatBox">Loading messages...</div>
<input type="text" id="msgInput" placeholder="Type your message...">
<button id="sendBtn">Send</button>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY",
  authDomain:"mobile-lab-mityana-aeae2.firebaseapp.com",
  projectId:"mobile-lab-mityana-aeae2"
});

const auth = firebase.auth();
const db = firebase.firestore();
const chatBox = document.getElementById("chatBox");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");

const doctorId = "ADMIN_DOCTOR_UID"; // replace with your admin UID

auth.onAuthStateChanged(user=>{
  if(!user) return location.href="login.html";

  // Real-time messages
  db.collection("chats")
    .where("receiverId","==",user.uid)  // messages sent to this patient
    .orderBy("timestamp","asc")
    .onSnapshot(snapshot=>{
      chatBox.innerHTML = "";
      snapshot.docs.forEach(doc=>{
        const msg = doc.data();
        const div = document.createElement("div");
        div.className = "message " + (msg.senderId === user.uid ? "sent" : "received");
        div.innerText = msg.message;
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });

  // Fetch patient sent messages too
  db.collection("chats")
    .where("senderId","==",user.uid)
    .orderBy("timestamp","asc")
    .onSnapshot(snapshot=>{
      snapshot.docs.forEach(doc=>{
        const msg = doc.data();
        const div = document.createElement("div");
        div.className = "message sent";
        div.innerText = msg.message;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    });
});

// Send message
sendBtn.onclick = async ()=>{
  const user = auth.currentUser;
  if(!user) return;
  const text = msgInput.value.trim();
  if(!text) return;

  await db.collection("chats").add({
    senderId: user.uid,
    receiverId: doctorId,
    message: text,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    status: "unread"
  });

  msgInput.value = "";
};
</script>
</body>
</html>
