<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ðŸ’¬ Chat with Admin</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{font-family:Arial;background:#f1f5f9;padding:20px;}
#chatBox{height:400px;overflow-y:auto;background:#fff;border-radius:12px;padding:10px;margin-bottom:10px;}
.message{padding:6px 10px;margin:5px 0;border-radius:12px;max-width:70%;}
.sent{background:#0ea5e9;color:#fff;margin-left:auto;}
.received{background:#e2e8f0;margin-right:auto;}
</style>
</head>
<body>

<h2>ðŸ’¬ Chat with Admin</h2>

<div id="chatBox"></div>

<input type="text" id="msgInput" placeholder="Type message">
<button id="sendBtn">Send</button>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY",
  authDomain: "mobile-lab-mityana-aeae2.firebaseapp.com",
  projectId: "mobile-lab-mityana-aeae2"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

const chatBox = document.getElementById("chatBox");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");

const adminUID = "DvmwZiewijWX8IBvKY5yF12ECqk1";

auth.onAuthStateChanged(user=>{
  if(!user) return location.href="login.html";

  const chatId = [adminUID, user.uid].sort().join("_");

  db.collection("chats")
    .doc(chatId)
    .collection("messages")
    .orderBy("timestamp")
    .onSnapshot(snapshot=>{
      chatBox.innerHTML = "";
      snapshot.forEach(doc=>{
        const msg = doc.data();
        const div = document.createElement("div");
        div.className = "message " + 
          (msg.senderId === user.uid ? "sent" : "received");
        div.innerText = msg.text;
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });
});

sendBtn.onclick = async ()=>{
  const text = msgInput.value.trim();
  if(!text) return;

  const user = auth.currentUser;
  const chatId = [adminUID, user.uid].sort().join("_");
  const chatRef = db.collection("chats").doc(chatId);

  await chatRef.set({
    participants:[adminUID,user.uid],
    lastMessage:text,
    lastTimestamp:firebase.firestore.FieldValue.serverTimestamp()
  },{merge:true});

  await chatRef.collection("messages").add({
    senderId:user.uid,
    text:text,
    timestamp:firebase.firestore.FieldValue.serverTimestamp(),
    status:"unread"
  });

  msgInput.value="";
};
</script>

</body>
</html>
