<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobile Lab Order â€“ Mityana Uganda</title>

<meta name="description" content="Book mobile lab tests in Mityana, Uganda.">
<meta name="theme-color" content="#4cafcb">

<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon-192.png">

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
  emailjs.init("QPXYuZG5LIiv_1x3H");
</script>

<style>
/* âœ… BACKGROUND IMAGE BEHIND THE WHOLE WEBSITE */
body{
  font-family: Arial, sans-serif;
  margin: 0;

  /* ðŸ”¥ Put your image name here (same folder as this HTML) */
  background:
    linear-gradient(rgba(244,247,250,0.85), rgba(244,247,250,0.85)),
    url("lab-bg.jpg") no-repeat center center fixed;
  background-size: cover;
}

/* âœ… MAIN CONTAINER */
.container{
  max-width:800px;
  margin:20px auto;
  background:#fff;
  padding:20px;
  border-radius:10px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}

/* âœ… HEADER */
.header{
  text-align:center;
  background:#4cafcb;
  color:#fff;
  padding:15px;
  border-radius:10px;
}

label{font-weight:bold}

input,select,textarea{
  width:100%;
  padding:10px;
  margin:5px 0 15px;
  border-radius:6px;
  border:1px solid #ccc;
  box-sizing: border-box;
}

.tests-container{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  max-height:350px;
  overflow:auto;
  border:1px solid #ccc;
  padding:10px;
  border-radius:6px;
  background:#fafafa;
}

.tests-container label{
  font-weight:normal;
  display:flex;
  align-items:center;
  gap:8px;
}

button{
  background:#4cafcb;
  color:#fff;
  padding:12px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  width:100%;
  font-size: 16px;
}

button:hover{background:#389ca0}

.payment-details{
  display:none;
  padding:10px;
  border-radius:6px;
  margin-bottom:10px;
  font-size: 14px;
}

#mtnDetails{background:#fff3cd}
#airtelDetails{background:#e0f7fa}

.order-preview{
  border:1px solid #ccc;
  padding:10px;
  border-radius:6px;
  margin-bottom:15px;
  background:#f9f9f9;
}

#confirmation{
  text-align:center;
  font-weight:bold;
  margin-top:15px;
}

/* âœ… MOBILE RESPONSIVE */
@media(max-width:600px){
  .tests-container{grid-template-columns:1fr}
}
</style>
</head>

<body>

<div class="container">
  <div class="header">
    <h2>ðŸ§ª Mobile Lab Order Form</h2>
    <p>For the love of your health</p>
  </div>

<form id="orderForm">

<label for="name">Full Name</label>
<input id="name" required>

<label for="email">Email</label>
<input type="email" id="email" required>

<label for="age">Age</label>
<input type="number" id="age" required>

<label for="sex">Sex</label>
<select id="sex" required>
  <option value="">-- Select --</option>
  <option>Male</option>
  <option>Female</option>
  <option>Other</option>
</select>

<label for="phone">Phone</label>
<input id="phone" required pattern="^(07|2567)[0-9]{8}$" placeholder="07XXXXXXXX or 2567XXXXXXXX">

<label>Select Tests</label>
<div class="tests-container" id="testsContainer"></div>

<label for="location">Location</label>
<input id="location" placeholder="Address or Google Maps link" required>

<label for="payment">Payment Method</label>
<select id="payment" required>
  <option value="">-- Select --</option>
  <option>Cash on Delivery</option>
  <option>MTN Mobile Money</option>
  <option>Airtel Money</option>
</select>

<div id="mtnDetails" class="payment-details">
  MTN Mobile Money: <b>0778379591 â€“ Kwikiriza Jenipher</b>
</div>

<div id="airtelDetails" class="payment-details">
  Airtel Money: <b>0706559100 â€“ Nambi Amina</b>
</div>

<label for="notes">Notes (Optional)</label>
<textarea id="notes" placeholder="Any extra information e.g. fasting, home landmark, preferred time..."></textarea>

<label>Total (UGX)</label>
<input id="total" readonly value="0">

<div class="order-preview" id="preview">No tests selected</div>

<button type="submit">Submit Order</button>

<p style="font-size:12px;color:#666;text-align:center">
Sample collection available within Mityana & nearby areas.
</p>

</form>

<div id="confirmation"></div>
</div>

<script>
// ---------- ELEMENTS ----------
const testsContainer = document.getElementById("testsContainer");
const totalInput = document.getElementById("total");
const preview = document.getElementById("preview");
const payment = document.getElementById("payment");
const mtnDetails = document.getElementById("mtnDetails");
const airtelDetails = document.getElementById("airtelDetails");
const confirmation = document.getElementById("confirmation");

// âœ… FIXED INPUTS (NO UNDEFINED)
const nameInput = document.getElementById("name");
const emailInput = document.getElementById("email");
const ageInput = document.getElementById("age");
const sexInput = document.getElementById("sex");
const phoneInput = document.getElementById("phone");
const locationInput = document.getElementById("location");
const notesInput = document.getElementById("notes");

// ---------- TESTS ----------
const tests = [
 {name:"Bleeding & Clotting Test",price:15000},
 {name:"Blood Glucose",price:7000},
 {name:"Blood Grouping",price:10000},
 {name:"Blood Smear",price:5000},
 {name:"Brucella Test",price:10000},
 {name:"CBC - Complete Blood Count",price:15000},
 {name:"Chlamydia Test",price:15000},
 {name:"Electrolytes",price:50000},
 {name:"Gonorrhea Test",price:15000},
 {name:"Pregnancy Test (hCG)",price:5000},
 {name:"Hepatitis B",price:10000},
 {name:"Hepatitis C",price:10000},
 {name:"HIV",price:7000},
 {name:"H. Pylori Serum",price:8000},
 {name:"H. Pylori Stool",price:20000},
 {name:"High Vaginal Swab",price:10000},
 {name:"High Vaginal Swab C&S",price:120000},
 {name:"Lipid Profile",price:40000},
 {name:"Liver Function Test (LFT)",price:50000},
 {name:"PSA",price:25000},
 {name:"Kidney Function Test (RFT)",price:50000},
 {name:"Rheumatoid Factor",price:15000},
 {name:"RPR / Syphilis",price:8000},
 {name:"Stool Analysis",price:15000},
 {name:"Urinalysis",price:8000},
 {name:"Widal Serum",price:8000},
 {name:"Widal Stool",price:20000},
 {name:"Gram Staining",price:10000},
 {name:"DNA",price:600000},
 {name:"Sickling Test",price:40000}
];

// ---------- RENDER TESTS ----------
tests.forEach(t=>{
  const label=document.createElement("label");
  const cb=document.createElement("input");
  cb.type="checkbox";
  cb.dataset.price=t.price;
  cb.value=t.name;
  cb.onchange=updateTotal;
  label.appendChild(cb);
  label.append(` ${t.name} (UGX ${t.price.toLocaleString()})`);
  testsContainer.appendChild(label);
});

function updateTotal(){
  let total=0,list=[];
  document.querySelectorAll("#testsContainer input:checked").forEach(cb=>{
    total+=Number(cb.dataset.price);
    list.push(`${cb.value} (UGX ${Number(cb.dataset.price).toLocaleString()})`);
  });
  totalInput.value=total.toLocaleString();
  preview.innerHTML=list.length?list.join("<br>"):"No tests selected";
}

payment.onchange=()=>{
  mtnDetails.style.display=payment.value==="MTN Mobile Money"?"block":"none";
  airtelDetails.style.display=payment.value==="Airtel Money"?"block":"none";
};

// ---------- SUBMIT ----------
document.getElementById("orderForm").onsubmit=e=>{
  e.preventDefault();
  if(totalInput.value==="0"){
    alert("Please select at least one test");
    return;
  }

  const orderId="ML-"+Date.now();

  const params={
    order_id:orderId,
    name:nameInput.value,
    email:emailInput.value,
    age:ageInput.value,
    sex:sexInput.value,
    phone:phoneInput.value,
    tests:preview.innerText,
    total:"UGX "+totalInput.value,
    location:locationInput.value,
    payment:payment.value,
    notes:notesInput.value||"None"
  };

  const waText=`Mobile Lab Order
Order ID: ${orderId}
Name: ${params.name}
Phone: ${params.phone}
Tests:
${preview.innerText}
Total: ${params.total}
Location: ${params.location}
Payment: ${params.payment}`;

  window.open(`https://wa.me/256750992939?text=${encodeURIComponent(waText)}`);

  emailjs.send("service_sjp4zrf","lab_order",params)
  .then(()=>{
    confirmation.innerHTML="âœ… Order submitted successfully!";
    e.target.reset();
    preview.innerHTML="No tests selected";
    totalInput.value="0";
    mtnDetails.style.display="none";
    airtelDetails.style.display="none";
  })
  .catch(()=>{
    confirmation.innerHTML="âŒ Failed to send order";
  });
};

// ---------- PWA ----------
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js")
    .then(() => console.log("âœ… PWA Service Worker registered"));
}
</script>

<!-- ðŸ”” FIREBASE PUSH NOTIFICATIONS -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

const firebaseConfig = {
  apiKey: "AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY",
  authDomain: "mobile-lab-mityana-aeae2.firebaseapp.com",
  projectId: "mobile-lab-mityana-aeae2",
  messagingSenderId: "624002906588",
  appId: "1:624002906588:web:08b4259f90ffa9adad7719"
};

const app = initializeApp(firebaseConfig);
const messaging = getMessaging(app);

// âœ… REGISTER SERVICE WORKER (FIXED PATH + SCOPE)
const reg = await navigator.serviceWorker.register(
  "/mobile-lab-mityana-ug/firebase-messaging-sw.js",
  { scope: "/mobile-lab-mityana-ug/" }
);

console.log("âœ… Service Worker registered");

// âœ… REQUEST PERMISSION
const permission = await Notification.requestPermission();

if (permission === "granted") {
  const token = await getToken(messaging, {
    vapidKey: "BDRlDDgqLQANN1vjJ1F16Z3oIQvY8VJC_eDLzGG3E53xzIMQ_HcHYv-S233aJ03lRwI2nZ0H_8dzqxuiju96QEw",
    serviceWorkerRegistration: reg
  });

  console.log("ðŸ”¥ FCM TOKEN:", token);
}

// âœ… FOREGROUND MESSAGE
onMessage(messaging, payload => {
  new Notification(payload.notification.title, {
    body: payload.notification.body,
    icon: "/mobile-lab-mityana-ug/icon-192.png"
  });
});
</script>

</body>
</html>
