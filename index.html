<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobile Lab â€“ Mityana</title>

<link rel="manifest" href="manifest.json">

<style>
body{font-family:Arial;background:#f4f7fa;margin:0}
header{background:#0a7cff;color:#fff;padding:15px;text-align:center}
.container{max-width:1000px;margin:20px auto;background:#fff;padding:20px;border-radius:10px}
.hidden{display:none}
button{padding:10px 15px;border:none;border-radius:5px;background:#0a7cff;color:#fff;cursor:pointer}
button.red{background:#d32f2f}
.section{margin-top:30px}
.card{border:1px solid #ddd;padding:15px;border-radius:8px;margin-bottom:15px}
.logout{margin-top:40px;text-align:center}
</style>
</head>

<body>

<header>
<h2>Mobile Laboratory â€“ Mityana</h2>
<p>Accurate â€¢ Affordable â€¢ Reliable</p>
</header>

<div class="container">

<!-- ACCOUNT INFO -->
<div id="accountInfo" class="card hidden">
<h3>Account Information</h3>
<p><b>Name:</b> <span id="accName"></span></p>
<p><b>Email:</b> <span id="accEmail"></span></p>
<p><b>Phone:</b> <span id="accPhone"></span></p>
<p><b>Role:</b> <span id="accRole"></span></p>
</div>

<!-- PATIENT DASHBOARD -->
<div id="patientDash" class="hidden">

<div class="section">
<h3>Available Tests</h3>

<div class="card">
<h4>Haematology</h4>
<ul>
<li>CBC â€“ UGX 20,000</li>
<li>ESR â€“ UGX 10,000</li>
<li>Blood Group â€“ UGX 5,000</li>
</ul>
</div>

<div class="card">
<h4>Biochemistry</h4>
<ul>
<li>FBS â€“ UGX 10,000</li>
<li>RFT â€“ UGX 35,000</li>
<li>LFT â€“ UGX 35,000</li>
<li>Lipid Profile â€“ UGX 40,000</li>
</ul>
</div>

<div class="card">
<h4>Serology</h4>
<ul>
<li>HIV â€“ UGX 10,000</li>
<li>HBsAg â€“ UGX 15,000</li>
<li>H. Pylori â€“ UGX 20,000</li>
</ul>
</div>

</div>

<div class="section">
<button onclick="location.href='inbox.html'">ðŸ“¥ View Results Inbox</button>
</div>

</div>

<!-- ADMIN DASHBOARD -->
<div id="adminDash" class="hidden">

<div class="section">
<h3>Admin â€“ Pending Requests</h3>
<div id="orders"></div>
</div>

</div>

<div class="logout">
<button id="logoutBtn" class="red hidden">Logout</button>
</div>

</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY",
  authDomain: "mobile-lab-mityana-aeae2.firebaseapp.com",
  projectId: "mobile-lab-mityana-aeae2",
  storageBucket: "mobile-lab-mityana-aeae2.appspot.com",
  messagingSenderId: "624002906588",
  appId: "1:624002906588:web:08b4259f90ffa9adad7719"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const ADMIN_EMAIL = "edrinehero@gmail.com";

auth.onAuthStateChanged(async user=>{
  if(!user){
    window.location.href="login.html";
    return;
  }

  document.getElementById("logoutBtn").classList.remove("hidden");
  document.getElementById("accountInfo").classList.remove("hidden");

  document.getElementById("accEmail").textContent = user.email || "â€”";
  document.getElementById("accPhone").textContent = user.phoneNumber || "â€”";

  const snap = await db.collection("users").doc(user.uid).get();
  if(snap.exists){
    document.getElementById("accName").textContent = snap.data().name || "";
  }

  if(user.email === ADMIN_EMAIL){
    document.getElementById("accRole").textContent="Admin";
    document.getElementById("adminDash").classList.remove("hidden");
    loadOrders();
  }else{
    document.getElementById("accRole").textContent="Patient";
    document.getElementById("patientDash").classList.remove("hidden");
  }
});

document.getElementById("logoutBtn").onclick=()=>{
  auth.signOut();
};

async function loadOrders(){
  const ordersDiv=document.getElementById("orders");
  ordersDiv.innerHTML="Loading...";
  const q=await db.collection("orders").orderBy("created","desc").get();
  ordersDiv.innerHTML="";
  q.forEach(d=>{
    const o=d.data();
    ordersDiv.innerHTML+=`
      <div class="card">
      <p><b>Patient:</b> ${o.name}</p>
      <p><b>Tests:</b> ${o.tests.join(", ")}</p>
      <button onclick="markDone('${d.id}')">Mark Done</button>
      </div>`;
  });
}

function markDone(id){
  db.collection("orders").doc(id).update({status:"Completed"});
  alert("Marked as completed");
}
</script>

</body>
</html>
