<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobile Lab Order ‚Äì Mityana Uganda</title>

<meta name="description" content="Book mobile lab tests in Mityana, Uganda.">
<meta name="theme-color" content="#0ea5e9">

<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon-192.png">

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
  emailjs.init("QPXYuZG5LIiv_1x3H");
</script>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --primary:#0ea5e9;
  --primary2:#14b8a6;
  --dark:#0f172a;
  --muted:#64748b;
  --border:rgba(15,23,42,0.12);
  --card:rgba(255,255,255,0.92);
  --shadow:0 12px 30px rgba(2,6,23,0.12);
}
*{box-sizing:border-box}
body{
  font-family: Arial, sans-serif;
  margin: 0;
  background:
    linear-gradient(rgba(241,245,249,0.82), rgba(241,245,249,0.82)),
    url("lab-bg.jpg") no-repeat center center fixed;
  background-size: cover;
  color: var(--dark);
}
.container{max-width: 900px;margin: 18px auto;padding: 16px;}
.card{
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 18px;
  box-shadow: var(--shadow);
  overflow: hidden;
}
.header{
  background: linear-gradient(135deg, var(--primary), var(--primary2));
  color:#fff;
  padding: 18px 16px;
  text-align:center;
  position: relative;
}
.header h2{margin: 0;font-size: 22px;}
.header p{margin: 6px 0 0;font-size: 13px;opacity: 0.95;}
.header-actions{
  margin-top: 12px;
  display:flex;
  justify-content:center;
  gap:10px;
  flex-wrap: wrap;
}
.call-btn{
  text-decoration:none;
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border-radius: 999px;
  font-weight: 800;
  font-size: 13px;
  color:#fff;
  border: 1px solid rgba(255,255,255,0.35);
  background: rgba(255,255,255,0.14);
}
.call-btn:hover{background: rgba(255,255,255,0.22);}
.form-body{padding: 18px;}
.grid2{display: grid;grid-template-columns: 1fr 1fr;gap: 12px;}
@media(max-width:720px){.grid2{grid-template-columns: 1fr;}}
label{font-weight: 700;font-size: 13px;color: var(--dark);}
input,select,textarea{
  width:100%;
  padding: 12px 12px;
  margin: 6px 0 14px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,0.95);
  outline: none;
  transition: 0.2s;
}
input:focus, select:focus, textarea:focus{
  border-color: rgba(14,165,233,0.7);
  box-shadow: 0 0 0 4px rgba(14,165,233,0.18);
}
small.note{
  display:block;
  margin-top:-10px;
  margin-bottom:12px;
  color: var(--muted);
  font-size: 12px;
}
.tools-bar{display:flex;gap:10px;align-items:center;margin: 8px 0 12px;}
.search{flex:1;margin:0;}
.badge{
  font-size: 12px;
  padding: 8px 10px;
  border-radius: 999px;
  background: rgba(20,184,166,0.15);
  border: 1px solid rgba(20,184,166,0.35);
  color: #0f766e;
  font-weight: 700;
}
.tests-area{
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 12px;
  background: rgba(255,255,255,0.65);
}
.category{margin-bottom: 14px;}
.cat-title{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  margin: 8px 0 10px;
}
.cat-title h3{font-size: 14px;margin: 0;color: var(--dark);}
.cat-title span{font-size: 12px;color: var(--muted);}
.tests-grid{display:grid;grid-template-columns: 1fr 1fr;gap: 10px;}
@media(max-width:720px){.tests-grid{grid-template-columns: 1fr;}}
.test-item{
  display:flex;
  gap: 10px;
  padding: 10px 10px;
  border: 1px solid var(--border);
  border-radius: 14px;
  background: rgba(255,255,255,0.92);
  cursor: pointer;
  transition: 0.18s;
}
.test-item:hover{
  transform: translateY(-1px);
  border-color: rgba(14,165,233,0.55);
  box-shadow: 0 10px 18px rgba(2,6,23,0.08);
}
.test-item input{width:auto;margin: 3px 0 0;}
.test-name{font-weight: 700;font-size: 13px;margin: 0;}
.test-price{font-size: 12px;color: var(--muted);margin: 3px 0 0;}
.payment-details{
  display:none;
  padding: 12px;
  border-radius: 14px;
  border: 1px solid var(--border);
  margin: -4px 0 12px;
  font-size: 13px;
}
#userDetails{
  background: rgba(14,165,233,0.08);
  padding: 12px;
  border-radius: 14px;
  margin-bottom: 12px;
  font-size: 14px;
}
#logoutBtn{
  margin-top: 16px;
  padding:10px 14px;
  border:none;
  border-radius:12px;
  background:#ef4444;
  color:#fff;
  font-weight:900;
  cursor:pointer;
  position: fixed;
  bottom: 18px;
  right: 18px;
}
#logoutBtn:hover{filter:brightness(0.95);}
.inbox-btn{
  display:block;
  margin: 10px 0;
  padding: 12px;
  text-align:center;
  border-radius:14px;
  background: var(--primary);
  color:#fff;
  font-weight:700;
  text-decoration:none;
}
.inbox-btn:hover{background: var(--primary2);}
.admin-section{
  display:none;
  margin-top:12px;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--border);
  background:rgba(255,255,255,0.88);
}
.admin-section textarea{
  width:100%; padding:10px; margin-bottom:10px; border-radius:10px; border:1px solid var(--border);
}
.admin-section select{
  width:100%; padding:10px; border-radius:10px; border:1px solid var(--border); margin-bottom:10px;
}
.admin-section button{
  background: var(--primary2); color:#fff; padding:10px; width:100%; border:none; border-radius:12px; font-weight:700; cursor:pointer;
}
.admin-section button:hover{filter:brightness(0.95);}
</style>
</head>
<body>

<div class="container">
  <div class="card">
    <div class="header">
      <h2>üß™ Mobile Lab Order Form</h2>
      <p>For the love of your health ‚Ä¢ Mityana & Nearby Areas</p>
      <div class="header-actions">
        <a class="call-btn" href="tel:+256778379791">üìû Call MTN: +256 778 379 791</a>
        <a class="call-btn" href="tel:0750992939">üìû Call Airtel: 0750 992 939</a>
      </div>
    </div>

    <!-- Logged-in User Info -->
    <div id="userDetails"></div>

    <!-- Inbox button for patients -->
    <a href="inbox.html" class="inbox-btn" id="inboxBtn" style="display:none;">üì• View My Orders</a>

    <!-- Admin Section -->
    <div class="admin-section" id="adminSection">
      <h3>Admin: Fill Test Results</h3>
      <table id="adminOrders" border="1" style="width:100%; margin-bottom:10px; border-collapse:collapse;"></table>
      <textarea id="resultText" placeholder="Enter results here..."></textarea>
      <select id="statusSelect">
        <option value="Completed">Completed ‚úÖ</option>
        <option value="Lacking">Lacking ‚ö†Ô∏è</option>
        <option value="Pending">Pending ‚è≥</option>
      </select>
      <button id="sendWhatsAppBtn">Send via WhatsApp</button>
    </div>

    <!-- Order Form -->
    <form id="orderForm" class="form-body">
      <div class="grid2">
        <div>
          <label for="name">Full Name</label>
          <input id="name" required placeholder="e.g. Namiyingo Joyce">
        </div>

        <div>
          <label for="email">Email</label>
          <input type="email" id="email" required placeholder="e.g. name@gmail.com">
        </div>

        <div>
          <label for="age">Age</label>
          <input type="number" id="age" required placeholder="e.g. 25">
        </div>

        <div>
          <label for="sex">Sex</label>
          <select id="sex" required>
            <option value="">-- Select --</option>
            <option>Male</option>
            <option>Female</option>
            <option>Other</option>
          </select>
        </div>

        <div>
          <label for="phone">Phone</label>
          <input id="phone" required pattern="^(07|2567)[0-9]{8}$" placeholder="07XXXXXXXX or 2567XXXXXXXX">
          <small class="note">Example: 0750992939</small>
        </div>

        <div>
          <label for="location">Location</label>
          <input id="location" placeholder="Address or Google Maps link" required>
          <small class="note">Add landmark for easy pickup</small>
        </div>
      </div>

      <label>Select Tests</label>
      <div class="tools-bar">
        <input class="search" id="searchTests" placeholder="Search test..."/>
        <div class="badge" id="selectedCount">0 selected</div>
      </div>
      <div class="tests-area" id="testsContainer"></div>

      <label for="payment">Payment Method</label>
      <select id="payment" required>
        <option value="">-- Select --</option>
        <option>Cash on Delivery</option>
        <option>MTN Mobile Money</option>
        <option>Airtel Money</option>
      </select>

      <div id="mtnDetails" class="payment-details">
        MTN Mobile Money: <b>0778379591 ‚Äì Kwikiriza Jenipher</b>
      </div>
      <div id="airtelDetails" class="payment-details">
        Airtel Money: <b>0706559100 ‚Äì Nambi Amina</b>
      </div>

      <label for="notes">Notes (Optional)</label>
      <textarea id="notes" placeholder="Any extra info e.g. fasting, preferred time, symptoms..."></textarea>

      <button type="submit">Submit Order</button>
      <div id="confirmation"></div>

      <button type="button" id="logoutBtn">Logout</button>
    </form>
  </div>
</div>

<script>
// Firebase init
const firebaseConfig = {
  apiKey: "AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY",
  authDomain: "mobile-lab-mityana-aeae2.firebaseapp.com",
  projectId: "mobile-lab-mityana-aeae2",
  storageBucket: "mobile-lab-mityana-aeae2.firebasestorage.app",
  messagingSenderId: "624002906588",
  appId: "1:624002906588:web:08b4259f90ffa9adad7719",
};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

// Elements
const testsContainer = document.getElementById("testsContainer");
const totalInput = document.createElement("input"); // placeholder, can add later
const totalText = document.createElement("div"); // placeholder
const preview = document.createElement("div"); // placeholder
const payment = document.getElementById("payment");
const mtnDetails = document.getElementById("mtnDetails");
const airtelDetails = document.getElementById("airtelDetails");
const confirmation = document.getElementById("confirmation");
const searchTests = document.getElementById("searchTests");
const selectedCount = document.getElementById("selectedCount");
const inboxBtn = document.getElementById("inboxBtn");
const adminSection = document.getElementById("adminSection");
const userDetailsDiv = document.getElementById("userDetails");

// Admin WhatsApp
const adminWhatsApp = "256750992939";

// All your tests (full list)
const testCategories = [
  { title: "Blood Tests", tests: [
      {name:"CBC - Complete Blood Count",price:15000},
      {name:"Blood Glucose",price:7000},
      {name:"Blood Grouping",price:10000},
      {name:"Bleeding & Clotting Test",price:15000},
      {name:"Malaria (B/S)",price:5000},
      {name:"Electrolytes",price:50000},
      {name:"Lipid Profile",price:40000},
      {name:"Liver Function Test (LFT)",price:50000},
      {name:"Kidney Function Test (RFT)",price:50000},
      {name:"PSA",price:25000},
      {name:"Sickling Test",price:40000},
      {name:"DNA",price:600000}
    ] },
  { title:"Infections / STIs", tests:[
      {name:"HIV",price:7000},
      {name:"Hepatitis B",price:10000},
      {name:"Hepatitis C",price:10000},
      {name:"RPR / Syphilis",price:8000},
      {name:"Gonorrhea Test",price:15000},
      {name:"Chlamydia Test",price:15000},
      {name:"Brucella Test",price:10000}
    ] },
  { title:"Stool / Urine", tests:[
      {name:"Urinalysis",price:8000},
      {name:"Stool Analysis",price:15000},
      {name:"H. Pylori Stool",price:20000},
      {name:"Widal Stool",price:20000}
    ] },
  { title:"H. Pylori / Gastro", tests:[{name:"H. Pylori Serum",price:8000}] },
  { title:"Women's Health", tests:[
      {name:"Pregnancy Test (hCG)",price:5000},
      {name:"High Vaginal Swab",price:10000},
      {name:"High Vaginal Swab C&S",price:120000},
      {name:"Gram Staining",price:10000}
    ] },
  { title:"Widal / Febrile Illness", tests:[{name:"Widal Serum",price:8000}] },
  { title:"Autoimmune / Others", tests:[{name:"Rheumatoid Factor",price:15000}] }
];

// Render tests
function renderTests(filterText=""){
  testsContainer.innerHTML="";
  testCategories.forEach(cat=>{
    const filtered = cat.tests.filter(t=>t.name.toLowerCase().includes(filterText.toLowerCase()));
    if(filtered.length===0) return;
    const wrapper = document.createElement("div"); wrapper.className="category";
    const titleRow = document.createElement("div"); titleRow.className="cat-title";
    titleRow.innerHTML=`<h3>‚úÖ ${cat.title}</h3><span>${filtered.length} tests</span>`;
    const grid = document.createElement("div"); grid.className="tests-grid";
    filtered.forEach(t=>{
      const label=document.createElement("label"); label.className="test-item";
      const cb=document.createElement("input"); cb.type="checkbox"; cb.dataset.price=t.price; cb.value=t.name;
      const info=document.createElement("div"); info.innerHTML=`<p class="test-name">${t.name}</p><p class="test-price">UGX ${t.price.toLocaleString()}</p>`;
      label.appendChild(cb); label.appendChild(info); grid.appendChild(label);
    });
    wrapper.appendChild(titleRow); wrapper.appendChild(grid); testsContainer.appendChild(wrapper);
  });
}
renderTests();
  <script>
/* ================= AUTH STATE ================= */
auth.onAuthStateChanged(async user => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  userDetailsDiv.innerHTML = `
    <b>Account:</b> ${user.email}<br>
    <b>User ID:</b> ${user.uid}
  `;

  inboxBtn.style.display = "block";

  // ADMIN CHECK (EMAIL BASED)
  if (user.email === "edrinehero@gmail.com") {
    adminSection.style.display = "block";
    loadAdminOrders();
  }
});

/* ================= LOGOUT ================= */
document.getElementById("logoutBtn").onclick = () => {
  auth.signOut().then(() => location.href = "login.html");
};

/* ================= SEARCH ================= */
searchTests.addEventListener("input", e => {
  renderTests(e.target.value);
});

/* ================= SELECT COUNT ================= */
document.addEventListener("change", () => {
  const checked = document.querySelectorAll(".test-item input:checked").length;
  selectedCount.innerText = `${checked} selected`;
});

/* ================= PAYMENT TOGGLE ================= */
payment.addEventListener("change", () => {
  mtnDetails.style.display = payment.value === "MTN Mobile Money" ? "block" : "none";
  airtelDetails.style.display = payment.value === "Airtel Money" ? "block" : "none";
});

/* ================= SUBMIT ORDER ================= */
document.getElementById("orderForm").addEventListener("submit", async e => {
  e.preventDefault();

  const selectedTests = [];
  document.querySelectorAll(".test-item input:checked").forEach(cb => {
    selectedTests.push({
      name: cb.value,
      price: cb.dataset.price
    });
  });

  if (selectedTests.length === 0) {
    alert("Please select at least one test");
    return;
  }

  const user = auth.currentUser;

  await db.collection("orders").add({
    userId: user.uid,
    email: user.email,
    name: name.value,
    age: age.value,
    sex: sex.value,
    phone: phone.value,
    location: location.value,
    tests: selectedTests,
    payment: payment.value,
    notes: notes.value,
    status: "Pending",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  confirmation.innerHTML = "‚úÖ Order submitted successfully";
  document.getElementById("orderForm").reset();
  selectedCount.innerText = "0 selected";
});

/* ================= ADMIN LOAD ORDERS ================= */
function loadAdminOrders() {
  const table = document.getElementById("adminOrders");
  table.innerHTML = `
    <tr>
      <th>Patient</th>
      <th>Phone</th>
      <th>Tests</th>
      <th>Status</th>
    </tr>
  `;

  db.collection("orders")
    .orderBy("createdAt", "desc")
    .onSnapshot(snapshot => {
      snapshot.forEach(doc => {
        const d = doc.data();
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${d.name}</td>
          <td>${d.phone}</td>
          <td>${d.tests.map(t=>t.name).join(", ")}</td>
          <td>${d.status}</td>
        `;
        table.appendChild(row);
      });
    });
}

/* ================= WHATSAPP SEND ================= */
document.getElementById("sendWhatsAppBtn").onclick = () => {
  const text = document.getElementById("resultText").value;
  if (!text) return alert("Enter results");

  const link = `https://wa.me/${adminWhatsApp}?text=${encodeURIComponent(text)}`;
  window.open(link, "_blank");
};
  <script>
/* ================= AUTH STATE ================= */
auth.onAuthStateChanged(async user => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  userDetailsDiv.innerHTML = `
    <b>Account:</b> ${user.email}<br>
    <b>User ID:</b> ${user.uid}
  `;

  inboxBtn.style.display = "block";

  // ADMIN CHECK (EMAIL BASED)
  if (user.email === "edrinehero@gmail.com") {
    adminSection.style.display = "block";
    loadAdminOrders();
  }
});

/* ================= LOGOUT ================= */
document.getElementById("logoutBtn").onclick = () => {
  auth.signOut().then(() => location.href = "login.html");
};

/* ================= SEARCH ================= */
searchTests.addEventListener("input", e => {
  renderTests(e.target.value);
});

/* ================= SELECT COUNT ================= */
document.addEventListener("change", () => {
  const checked = document.querySelectorAll(".test-item input:checked").length;
  selectedCount.innerText = `${checked} selected`;
});

/* ================= PAYMENT TOGGLE ================= */
payment.addEventListener("change", () => {
  mtnDetails.style.display = payment.value === "MTN Mobile Money" ? "block" : "none";
  airtelDetails.style.display = payment.value === "Airtel Money" ? "block" : "none";
});

/* ================= SUBMIT ORDER ================= */
document.getElementById("orderForm").addEventListener("submit", async e => {
  e.preventDefault();

  const selectedTests = [];
  document.querySelectorAll(".test-item input:checked").forEach(cb => {
    selectedTests.push({
      name: cb.value,
      price: cb.dataset.price
    });
  });

  if (selectedTests.length === 0) {
    alert("Please select at least one test");
    return;
  }

  const user = auth.currentUser;

  await db.collection("orders").add({
    userId: user.uid,
    email: user.email,
    name: name.value,
    age: age.value,
    sex: sex.value,
    phone: phone.value,
    location: location.value,
    tests: selectedTests,
    payment: payment.value,
    notes: notes.value,
    status: "Pending",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  confirmation.innerHTML = "‚úÖ Order submitted successfully";
  document.getElementById("orderForm").reset();
  selectedCount.innerText = "0 selected";
});

/* ================= ADMIN LOAD ORDERS ================= */
function loadAdminOrders() {
  const table = document.getElementById("adminOrders");
  table.innerHTML = `
    <tr>
      <th>Patient</th>
      <th>Phone</th>
      <th>Tests</th>
      <th>Status</th>
    </tr>
  `;

  db.collection("orders")
    .orderBy("createdAt", "desc")
    .onSnapshot(snapshot => {
      snapshot.forEach(doc => {
        const d = doc.data();
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${d.name}</td>
          <td>${d.phone}</td>
          <td>${d.tests.map(t=>t.name).join(", ")}</td>
          <td>${d.status}</td>
        `;
        table.appendChild(row);
      });
    });
}

/* ================= WHATSAPP SEND ================= */
document.getElementById("sendWhatsAppBtn").onclick = () => {
  const text = document.getElementById("resultText").value;
  if (!text) return alert("Enter results");

  const link = `https://wa.me/${adminWhatsApp}?text=${encodeURIComponent(text)}`;
  window.open(link, "_blank");
};
</script>
  
</body>
</html>

