<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ðŸ§ª Patient Inbox â€“ Mobile Lab</title>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial,sans-serif;background:#f1f5f9;margin:0;padding:20px;}
h2{color:#0369a1;}
.card{background:#fff;padding:20px;border-radius:12px;margin-bottom:20px;border:1px solid #ccc;}
button{padding:8px 14px;border:none;border-radius:8px;background:#0ea5e9;color:white;cursor:pointer;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #ccc;padding:6px;}
th{background:#e2e8f0;}
.contact{margin-bottom:15px;background:#e0f2fe;padding:12px;border-radius:10px;}
.welcome{margin-bottom:15px;padding:12px;background:#d1fae5;border-left:6px solid #10b981;}
</style>
</head>

<body>

<div class="welcome">
  <h3>Welcome to Mobile Lab Mityana ðŸ§ª</h3>
  <p>We are glad to have you here. Your lab results are always available and safe.</p>
</div>

<div class="contact">
  <p><b>Contact Us:</b> +256 778 379 591 | Email: edrinehero@gmail.com</p>
  <p><i>Remember: Regular checkups keep you healthy! ðŸŒ¿</i></p>
</div>

<h2>ðŸ§ª Your Lab Results</h2>
<div id="inbox">Loading...</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY",
  authDomain:"mobile-lab-mityana-aeae2.firebaseapp.com",
  projectId:"mobile-lab-mityana-aeae2"
});

const auth = firebase.auth();
const db = firebase.firestore();
const inbox = document.getElementById("inbox");

auth.onAuthStateChanged(user=>{
  if(!user) return location.href="login.html";

  db.collection("results")
    .where("userId","==",user.uid)
    .orderBy("uploaded_at","desc")
    .onSnapshot(async snapshot=>{

      inbox.innerHTML="";

      if(snapshot.empty){
        inbox.innerHTML="<p>No results yet.</p>";
        return;
      }

      for(const doc of snapshot.docs){
        const r = doc.data();
        let age = "N/A";

        // Fetch age from orders collection
        if(r.order_id){
          const orderSnap = await db.collection("orders").doc(r.order_id).get();
          if(orderSnap.exists && orderSnap.data().age) age = orderSnap.data().age;
        }

        const card = document.createElement("div");
        card.className="card";

        let html = `
          <h3>${r.patient_name || "Patient"}</h3>
          <p><b>Email:</b> ${r.patient_email || ""}</p>
          <p><b>Age:</b> ${age}</p>
          <p><b>Client Number:</b> ${r.order_id || doc.id}</p>
          <p><b>Date:</b> ${r.uploaded_at ? new Date(r.uploaded_at.toDate()).toLocaleDateString() : "N/A"}</p>
        `;

        if(r.results){
          html += `
            <table>
              <thead>
                <tr>
                  <th>Test</th>
                  <th>Result</th>
                </tr>
              </thead>
              <tbody>
          `;
          Object.entries(r.results).forEach(([test,value])=>{
            html += `<tr><td>${test}</td><td>${value}</td></tr>`;
          });
          html += `</tbody></table>`;
        }

        html += `<br><button class="download">Download PDF</button>`;
        card.innerHTML = html;
        inbox.appendChild(card);

        card.querySelector(".download").onclick = async () => {
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF("p","mm","a4");
          let y = 20;

          // HEADER BAR
          pdf.setFillColor(14, 165, 233); 
          pdf.rect(0, 0, 210, 25, "F");
          pdf.setFontSize(20);
          pdf.setTextColor(255,255,255);
          pdf.text("MOBILE LAB", 105,17,{align:"center"});

          y = 35;

          // LOGO
          const img = new Image();
          img.src = "logo.png";
          await new Promise(res=>img.onload=res);
          pdf.addImage(img, "PNG", 80, y, 50, 50);
          y += 55;

          // PATIENT INFO BOX
          pdf.setDrawColor(0);
          pdf.setFillColor(230,245,255);
          pdf.roundedRect(15, y, 180, 45, 5, 5, "F");
          pdf.setFontSize(12);
          pdf.setTextColor(0);
          pdf.text(`Patient Name: ${r.patient_name || "N/A"}`, 20, y + 10);
          pdf.text(`Email: ${r.patient_email || "N/A"}`, 20, y + 18);
          pdf.text(`Age: ${age}`, 20, y + 26);
          pdf.text(`Client No.: ${r.order_id || doc.id}`, 120, y + 10);
          pdf.text(`Date: ${r.uploaded_at ? new Date(r.uploaded_at.toDate()).toLocaleDateString() : "N/A"}`, 120, y + 18);
          y += 55;

          // TESTS TABLE HEADER
          pdf.setFillColor(14,165,233);
          pdf.setTextColor(255);
          pdf.setFontSize(12);
          pdf.rect(15, y, 180, 8, "F");
          pdf.text("Test", 20, y + 6);
          pdf.text("Result", 150, y + 6);
          y += 8;

          // TESTS ROWS
          pdf.setFontSize(11);
          pdf.setTextColor(0);
          let rowToggle = false;
          Object.entries(r.results || {}).forEach(([test,value])=>{
            pdf.setFillColor(rowToggle ? 245:255, rowToggle ? 245:255, rowToggle ? 245:255);
            pdf.rect(15, y, 180, 8, "F");
            pdf.text(test, 20, y + 6);
            pdf.text(value, 150, y + 6);
            y += 8;
            rowToggle = !rowToggle;
          });

          y += 15;
          pdf.setFontSize(12);
          pdf.setTextColor(14,165,233);
          pdf.text("Prepared by Edrine, Labtech",105,y,{align:"center"});
          y += 7;
          pdf.setFontSize(10);
          pdf.setTextColor(50);
          pdf.text("Thank you for choosing Mobile Lab Mityana! Stay healthy. ðŸŒ¿",105,y,{align:"center"});

          pdf.save(`Patient_${r.patient_name || doc.id}.pdf`);
        };
      }
    });
});
</script>

</body>
</html>
