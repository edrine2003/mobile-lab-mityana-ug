<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ðŸ§ª Patient Inbox â€“ Mobile Lab</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#f1f5f9;margin:0;padding:20px}
.card{background:#fff;padding:20px;border-radius:12px;margin-bottom:20px;border:1px solid #ccc}
button{padding:8px 14px;border:none;border-radius:8px;background:#0ea5e9;color:white;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px}
th{background:#e2e8f0}
</style>
</head>

<body>

<h2>ðŸ§ª Your Lab Results</h2>
<div id="inbox">Loading...</div>

<script>

firebase.initializeApp({
  apiKey:"AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY",
  authDomain:"mobile-lab-mityana-aeae2.firebaseapp.com",
  projectId:"mobile-lab-mityana-aeae2"
});

const auth = firebase.auth();
const db = firebase.firestore();
const inbox = document.getElementById("inbox");

auth.onAuthStateChanged(user=>{
  if(!user) return location.href="login.html";

  // ðŸ”¥ MATCH YOUR REAL DATABASE STRUCTURE
  db.collection("results")
    .where("userId","==",user.uid)
    .orderBy("uploaded_at","desc")
    .onSnapshot(snapshot=>{

      inbox.innerHTML="";

      if(snapshot.empty){
        inbox.innerHTML="<p>No results yet.</p>";
        return;
      }

      snapshot.forEach(doc=>{
        const r = doc.data();

        const card=document.createElement("div");
        card.className="card";

        let html = `
          <h3>${r.patient_name || "Patient"}</h3>
          <p><b>Email:</b> ${r.patient_email || ""}</p>
        `;

        // SIMPLE RESULTS STRUCTURE
        Object.entries(r.results || {}).forEach(([test,value])=>{
          html += `
            <table>
              <tr>
                <th>Test</th>
                <th>Result</th>
              </tr>
              <tr>
                <td>${test}</td>
                <td>${value}</td>
              </tr>
            </table>
          `;
        });

        html += `<br><button class="download">Download PDF</button>`;

        card.innerHTML = html;
        inbox.appendChild(card);

        // ===== PDF GENERATOR =====
        card.querySelector(".download").onclick = async ()=>{

          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF("p","mm","a4");

          let y = 20;

          // HEADER
          pdf.setFontSize(18);
          pdf.text("MOBILE LAB SERVICES",105,y,{align:"center"});
          y+=10;

          pdf.setFontSize(12);
          pdf.text("Mityana, Uganda",105,y,{align:"center"});
          y+=15;

          // PATIENT DETAILS
          pdf.text("Patient Name: "+(r.patient_name||""),20,y); y+=8;
          pdf.text("Email: "+(r.patient_email||""),20,y); y+=12;

          pdf.setFontSize(13);
          pdf.text("Results:",20,y); y+=8;

          pdf.setFontSize(11);

          Object.entries(r.results || {}).forEach(([test,value])=>{
            pdf.text(test + ": " + value,20,y);
            y+=8;
          });

          y+=20;

          pdf.text("_________________________",20,y);
          y+=6;
          pdf.text("Laboratory Officer",20,y);

          pdf.save("Lab_Result_"+doc.id+".pdf");
        };
      });
    });
});
</script>

</body>
</html>
