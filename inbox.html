<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üß™ Patient Inbox ‚Äì Mobile Lab</title>
<meta name="description" content="View your lab results securely.">
<meta name="theme-color" content="#0ea5e9">

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
  background: #f1f5f9;
  color: #0f172a;
}
.container {
  max-width: 900px;
  margin: 20px auto;
  padding: 16px;
}
.header {
  background: linear-gradient(135deg, #0ea5e9, #14b8a6);
  color: #fff;
  padding: 18px;
  text-align: center;
  border-radius: 12px;
  position: relative;
}
.header h2 { margin:0; }
.header p { margin: 6px 0 0; font-size: 14px; opacity: 0.9; }
#logoutBtn {
  background: #ef4444;
  color: #fff;
  padding: 12px 18px;
  border: none;
  border-radius: 999px;
  font-weight: 800;
  cursor: pointer;
  position: absolute;
  top: 16px;
  right: 16px;
}
.results {
  margin-top: 20px;
}
.result-card {
  background: #fff;
  padding: 16px;
  border-radius: 12px;
  border: 1px solid rgba(15,23,42,0.12);
  margin-bottom: 20px;
}
.result-card h4 {
  margin: 0 0 10px;
  color: #0369a1;
}
.result-card table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 12px;
}
.result-card th, .result-card td {
  border: 1px solid #cbd5e1;
  padding: 6px 8px;
  text-align: left;
}
.result-card th {
  background: #e2e8f0;
}
.result-card p {
  margin: 4px 0;
  font-size: 13px;
  color: #334155;
}
.result-card i {
  font-size: 11px;
  color: #64748b;
}
.delete-btn {
  background: #ef4444;
  color: #fff;
  border: none;
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
}
.delete-btn:hover {
  filter: brightness(0.9);
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h2>üß™ Patient Inbox</h2>
    <p>View your uploaded lab results securely.</p>
    <button id="logoutBtn">Logout</button>
  </div>

  <div class="results" id="inboxContainer">
    Loading your lab results...
  </div>
</div>

<script>
// üîπ Firebase init
const firebaseConfig = {
  apiKey: "AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY",
  authDomain: "mobile-lab-mityana-aeae2.firebaseapp.com",
  projectId: "mobile-lab-mityana-aeae2",
  storageBucket: "mobile-lab-mityana-aeae2.firebasestorage.app",
  messagingSenderId: "624002906588",
  appId: "1:624002906588:web:08b4259f90ffa9adad7719",
};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
const inboxContainer = document.getElementById("inboxContainer");

// üîπ Require login
auth.onAuthStateChanged(async user => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  try {
    db.collection("results")
      .where("patient_email", "==", user.email)
      .orderBy("uploaded_at", "desc")
      .onSnapshot(snapshot => {
        inboxContainer.innerHTML = "";
        if (snapshot.empty) {
          inboxContainer.innerHTML = "<p>No results uploaded yet.</p>";
          return;
        }

        snapshot.forEach(doc => {
          const data = doc.data();
          const card = document.createElement("div");
          card.className = "result-card";

          const uploadedDate = data.uploaded_at 
            ? new Date(data.uploaded_at.seconds * 1000).toLocaleString() 
            : "Unknown";

          let html = `<h4>Order ID: ${data.order_id}</h4>
                      <p><strong>Uploaded on:</strong> ${uploadedDate}</p>`;

          // Loop through tests
          const results = data.results;
          if (results && typeof results === "object") {
            Object.keys(results).forEach(testName => {
              const testData = results[testName];
              if (typeof testData === "object") {
                html += `<h4>${testName}</h4><table>
                          <tr><th>Parameter</th><th>Units</th><th>Result</th></tr>`;
                Object.keys(testData).forEach(paramKey => {
                  const paramData = testData[paramKey];
                  html += `<tr>
                            <td>${paramData.param || "N/A"}</td>
                            <td>${paramData.units || ""}</td>
                            <td>${paramData.result || paramData || "Pending"}</td>
                          </tr>`;
                });
                html += "</table>";
              } else {
                html += `<p><strong>${testName}:</strong> ${testData}</p>`;
              }
            });
          } else {
            html += `<p>Results pending</p>`;
          }

          html += `<button class="delete-btn">üóëÔ∏è Delete</button>`;
          card.innerHTML = html;

          const deleteBtn = card.querySelector(".delete-btn");
          deleteBtn.addEventListener("click", async () => {
            const sure = confirm("Are you sure you want to delete this result?");
            if (!sure) return;
            try {
              await db.collection("results").doc(doc.id).delete();
              alert("‚úÖ Result deleted");
            } catch(err) {
              console.error(err);
              alert("Permission denied");
            }
          });

          inboxContainer.appendChild(card);
        });
      });

  } catch(err) {
    console.error(err);
    inboxContainer.innerHTML = "<p>Failed to load results. Please try again later.</p>";
  }
});

// üîπ Logout
document.getElementById("logoutBtn").addEventListener("click", async ()=> {
  await auth.signOut();
  window.location.href = "login.html";
});
</script>

</body>
</html>

