<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ§ª Patient Inbox â€“ Mobile Lab</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#f1f5f9;margin:0}
.container{max-width:900px;margin:20px auto;padding:16px}
.header{
  background:linear-gradient(135deg,#0ea5e9,#14b8a6);
  color:#fff;padding:18px;border-radius:14px;
  position:relative;text-align:center
}
#logoutBtn{
  position:absolute;right:16px;top:16px;
  background:#ef4444;color:#fff;border:none;
  padding:10px 16px;border-radius:999px;cursor:pointer
}
.badge{
  background:#ef4444;color:white;
  padding:4px 10px;border-radius:999px;
  font-size:12px;font-weight:700;
  margin-left:8px
}
.result-card{
  background:#fff;padding:16px;margin-top:20px;
  border-radius:14px;border:1px solid #cbd5e1
}
.result-card h4{margin:0 0 8px;color:#0369a1}
table{width:100%;border-collapse:collapse;margin-bottom:10px}
th,td{border:1px solid #cbd5e1;padding:6px}
th{background:#e2e8f0}
button{
  padding:8px 12px;border:none;
  border-radius:8px;cursor:pointer;
  margin-right:6px
}
.download{background:#0ea5e9;color:white}
</style>
</head>

<body>
<div class="container">

  <div class="header">
    <h2>
      ðŸ§ª Patient Inbox
      <span id="newBadge" class="badge" style="display:none">NEW</span>
    </h2>
    <p>Your lab results appear instantly once ready</p>
    <button id="logoutBtn">Logout</button>
  </div>

  <div id="inbox">Loading resultsâ€¦</div>

</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY",
  authDomain:"mobile-lab-mityana-aeae2.firebaseapp.com",
  projectId:"mobile-lab-mityana-aeae2"
});

const auth=firebase.auth();
const db=firebase.firestore();
const inbox=document.getElementById("inbox");
const badge=document.getElementById("newBadge");

let lastSeen = localStorage.getItem("lastSeenResult") || 0;
let whatsappSent = localStorage.getItem("whatsappSent") || "";

auth.onAuthStateChanged(user=>{
  if(!user) return location.href="login.html";

  db.collection("results")
    .where("patientEmail","==",user.email)
    .orderBy("createdAt","desc")
    .onSnapshot(snapshot=>{
      inbox.innerHTML="";

      if(snapshot.empty){
        inbox.innerHTML="<p>No results yet.</p>";
        return;
      }

      snapshot.forEach(doc=>{
        const r=doc.data();
        const ts=r.createdAt?.toMillis()||0;

        if(ts > lastSeen){
          badge.style.display="inline-block";
          lastSeen=ts;
          localStorage.setItem("lastSeenResult",ts);

          if(whatsappSent !== doc.id){
            const msg = encodeURIComponent(
              "ðŸ§ª Your lab results are ready. Please open your Mobile Lab inbox to view them."
            );
            window.open(`https://wa.me/?text=${msg}`,"_blank");
            localStorage.setItem("whatsappSent",doc.id);
          }
        }

        const card=document.createElement("div");
        card.className="result-card";

        let html=`<h4>ðŸ§ª Test Results</h4>`;

        Object.keys(r.results||{}).forEach(test=>{
          html+=`<h4>${test}</h4><table>
            <tr><th>Parameter</th><th>Units</th><th>Value</th></tr>`;
          Object.keys(r.results[test]).forEach(p=>{
            const v=r.results[test][p];
            html+=`
              <tr>
                <td>${p}</td>
                <td>${v.units}</td>
                <td>${v.value}</td>
              </tr>`;
          });
          html+=`</table>`;
        });

        html+=`
          <button class="download">â¬‡ Download PDF</button>
          <div style="font-size:12px;color:#64748b">
            ${r.createdAt?.toDate().toLocaleString()}
          </div>
        `;

        card.innerHTML=html;
        inbox.appendChild(card);

        card.querySelector(".download").onclick=()=>{
          const {jsPDF}=window.jspdf;
          const pdf=new jsPDF();
          let y=10;
          pdf.text("Mobile Lab Results",10,y);y+=8;

          Object.keys(r.results||{}).forEach(t=>{
            pdf.text(t,10,y);y+=6;
            Object.keys(r.results[t]).forEach(p=>{
              const v=r.results[t][p];
              pdf.text(`${p}: ${v.value} ${v.units}`,10,y);
              y+=6;
            });
          });

          pdf.save("Lab_Results.pdf");
        };
      });
    });
});

document.getElementById("logoutBtn").onclick=async()=>{
  await auth.signOut();
  location.href="login.html";
};
</script>
</body>
</html>
