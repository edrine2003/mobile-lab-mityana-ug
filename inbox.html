<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inbox â€“ Mobile Lab Admin</title>
<meta name="theme-color" content="#0ea5e9">

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{font-family:Arial,sans-serif;margin:0;background:#f4f7fa;color:#0f172a;}
.container{max-width:900px;margin:18px auto;padding:16px;}
.header{background:linear-gradient(135deg,#0ea5e9,#14b8a6);color:#fff;padding:16px;text-align:center;border-radius:18px 18px 0 0;margin-bottom:12px;}
.search-bar{margin:12px 0;}
.search-bar input{width:100%;padding:10px;border-radius:12px;border:1px solid #cbd5e1;}
.card{background:#fff;border-radius:18px;padding:16px;margin-bottom:12px;box-shadow:0 8px 20px rgba(0,0,0,0.06);}
textarea,input,select{width:100%;padding:8px;margin:6px 0 12px;border-radius:12px;border:1px solid #cbd5e1;}
button{padding:10px;background:linear-gradient(135deg,#0ea5e9,#14b8a6);color:#fff;border:none;border-radius:12px;cursor:pointer;margin-top:6px;width:100%;font-weight:700;box-shadow:0 6px 14px rgba(0,0,0,0.1);transition:0.2s;}
button:hover{filter:brightness(0.95);transform:translateY(-1px);}
.status{padding:4px 8px;border-radius:8px;font-size:13px;color:#fff;font-weight:700;}
.status.pending{background:#f97316;}
.status.completed{background:#16a34a;}
.status.lacking{background:#dc2626;}
.actions{margin-top:12px;}
</style>
</head>
<body>

<div class="container">
  <div class="header"><h2>ðŸ“¥ Inbox â€“ Lab Orders</h2></div>

  <div class="search-bar">
    <input type="text" id="searchOrders" placeholder="Search by patient name, phone, or order ID...">
  </div>

  <div id="ordersContainer"></div>
  <button id="logoutBtn">Logout</button>
</div>

<script>
// ðŸ”¹ Firebase Config â€“ replace with your own
const firebaseConfig = {
  apiKey: "AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY",
  authDomain: "mobile-lab-mityana-aeae2.firebaseapp.com",
  projectId: "mobile-lab-mityana-aeae2"
};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
const ordersContainer = document.getElementById("ordersContainer");

// ðŸ”¹ Admin only
auth.onAuthStateChanged(async(user)=>{
  if(!user){ window.location.href="login.html"; return; }
  const doc = await db.collection("users").doc(user.uid).get();
  const email = doc.exists ? doc.data().email : user.email;
  if(email!=="edrinehero@gmail.com"){
    alert("Access denied"); 
    window.location.href="index.html"; 
    return;
  }

  // ðŸ”¹ Load orders initially
  loadOrders();
});

// ðŸ”¹ Load orders with optional search filter
function loadOrders(filter=""){
  db.collection("orders").orderBy("createdAt","desc").onSnapshot(snapshot=>{
    ordersContainer.innerHTML="";
    if(snapshot.empty){ ordersContainer.innerHTML="<p>No orders yet</p>"; return; }

    snapshot.forEach(doc=>{
      const o = doc.data();
      const lowerFilter = filter.toLowerCase();
      if(filter && !(
        o.name.toLowerCase().includes(lowerFilter) ||
        o.phone.includes(filter) ||
        o.order_id.toLowerCase().includes(lowerFilter)
      )) return;

      const card = document.createElement("div");
      card.className="card";
      card.innerHTML=`
        <p><b>Order ID:</b> ${o.order_id}</p>
        <p><b>Patient:</b> ${o.name} | ${o.phone}</p>
        <p><b>Tests:</b><br>${o.tests.split(',').join('<br>')}</p>
        <p><b>Total:</b> ${o.total}</p>
        <p><b>Status:</b> <span class="status ${o.status.toLowerCase()}">${o.status}</span></p>

        <label>Results / Notes</label>
        <textarea id="res_${doc.id}" placeholder="Enter results here">${o.resultNotes||''}</textarea>
        <select id="status_${doc.id}">
          <option value="pending" ${o.status==="pending"?"selected":""}>Pending</option>
          <option value="completed" ${o.status==="completed"?"selected":""}>Completed</option>
          <option value="lacking" ${o.status==="lacking"?"selected":""}>Lacking</option>
        </select>

        <div class="actions">
          <button onclick="updateOrder('${doc.id}','${o.phone}','${o.name}')">ðŸ’¾ Update & Send WhatsApp</button>
        </div>
      `;
      ordersContainer.appendChild(card);
    });
  });
}

// ðŸ”¹ Search orders
document.getElementById("searchOrders").addEventListener("input",(e)=>{
  loadOrders(e.target.value.trim());
});

// ðŸ”¹ Update order & send WhatsApp
async function updateOrder(docId, phone, name){
  const results = document.getElementById(`res_${docId}`).value.trim();
  const status = document.getElementById(`status_${docId}`).value;

  if(!results){ alert("Please enter results before sending."); return; }

  await db.collection("orders").doc(docId).update({ 
    resultNotes: results, 
    status 
  });

  const waText = `Hello ${name},\nYour lab results are ready.\nStatus: ${status}\nResults:\n${results}`;
  window.open(`https://wa.me/256${phone.replace(/^0/,'')}?text=${encodeURIComponent(waText)}`);

  alert("Results updated & WhatsApp opened!");
}

// ðŸ”¹ Logout
document.getElementById("logoutBtn").addEventListener("click", async()=>{
  await auth.signOut();
  window.location.href="login.html";
});
</script>

</body>
</html>
