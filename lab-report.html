<!-- Include QRCode.js for QR generation if not already -->
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<script>
(async ()=>{

// --- Utilities ---
const textEncoder = new TextEncoder();
const textDecoder = new TextDecoder();

function bufToBase64(buf) {
  return btoa(String.fromCharCode(...new Uint8Array(buf)));
}
function base64ToBuf(b64) {
  const bin = atob(b64);
  const arr = new Uint8Array(bin.length);
  for (let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
  return arr.buffer;
}

async function deriveKey(passphrase, salt, iterations=150000) {
  const passKey = await crypto.subtle.importKey(
    'raw', textEncoder.encode(passphrase),
    {name:'PBKDF2'}, false, ['deriveKey']
  );
  return await crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt: salt, iterations: iterations, hash:'SHA-256' },
    passKey,
    { name: 'AES-GCM', length: 256 },
    false,
    ['encrypt','decrypt']
  );
}

// --- Encryption / Decryption ---
async function encryptReport(passphrase, jsonObj) {
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const key = await deriveKey(passphrase, salt.buffer);
  const plain = textEncoder.encode(JSON.stringify(jsonObj));
  const cipher = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, plain);
  return `${bufToBase64(salt.buffer)}.${bufToBase64(iv.buffer)}.${bufToBase64(cipher)}`;
}

async function decryptReport(passphrase, payload) {
  const parts = payload.split('.');
  if(parts.length !== 3) throw new Error('Invalid encrypted payload');
  const salt = base64ToBuf(parts[0]);
  const iv = new Uint8Array(base64ToBuf(parts[1]));
  const cipher = base64ToBuf(parts[2]);
  const key = await deriveKey(passphrase, salt);
  const plainBuf = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, cipher);
  return JSON.parse(textDecoder.decode(plainBuf));
}

// --- Modal passphrase UI ---
function promptPassphrase(message='Enter passphrase:') {
  return new Promise((resolve)=>{
    const modal = document.createElement('div');
    modal.style = `
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;
    `;
    modal.innerHTML = `
      <div style="background:#fff;padding:20px;border-radius:8px;min-width:300px;text-align:center;">
        <p>${message}</p>
        <input type="password" id="modalPass" style="width:80%;padding:8px;margin-bottom:10px;" />
        <br>
        <button id="okBtn">OK</button>
        <button id="cancelBtn">Cancel</button>
      </div>
    `;
    document.body.appendChild(modal);
    const input = modal.querySelector('#modalPass');
    input.focus();
    modal.querySelector('#okBtn').onclick = ()=>{ resolve(input.value); document.body.removeChild(modal); };
    modal.querySelector('#cancelBtn').onclick = ()=>{ resolve(null); document.body.removeChild(modal); };
  });
}

// --- Share / Load ---
async function makeEncryptedShareLink() {
  try {
    const data = gatherData(); // your existing function
    const pass = await promptPassphrase('Enter passphrase to encrypt this report:');
    if(!pass) return toast('Encryption canceled.');
    const payload = await encryptReport(pass, data);
    const url = `${location.origin}${location.pathname}#data=${encodeURIComponent(payload)}`;
    
    try { await navigator.clipboard.writeText(url); toast('Encrypted link copied!'); }
    catch { prompt('Encrypted link (copy manually):', url); }

    // QR Code
    const qrcodeEl = document.getElementById('qrcode');
    if(qrcodeEl){ qrcodeEl.innerHTML=''; QRCode.toCanvas(qrcodeEl, url, {width:120,height:120}).catch(console.error); }

    return url;
  } catch(err){ console.error(err); toast('Encryption failed: ' + err.message); }
}

async function tryLoadFromHash() {
  const m = location.hash.match(/#data=([^&]+)/);
  if(!m) return false;
  const payload = decodeURIComponent(m[1]);

  if(payload.split('.').length !== 3){
    // legacy unencrypted
    try { const json = JSON.parse(atob(payload)); applyData(json); toast('Loaded unencrypted report'); return true; }
    catch(e){ console.warn('Unrecognized hash', e); return false; }
  }

  const pass = await promptPassphrase('Report is locked. Enter passphrase:');
  if(!pass) { toast('Passphrase required.'); return false; }
  try { const data = await decryptReport(pass, payload); applyData(data); toast('Report decrypted'); return true; }
  catch(err){ console.error(err); alert('Incorrect passphrase or corrupted data.'); return false; }
}

// --- Export / Import ---
async function exportEncryptedJSONToFile() {
  const data = gatherData();
  const pass = await promptPassphrase('Enter passphrase for export:');
  if(!pass) return toast('Export canceled.');
  const payload = await encryptReport(pass, data);
  const blob = new Blob([payload], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${data.client?.id||'lab-report'}.enc.txt`;
  a.click();
  URL.revokeObjectURL(a.href);
  toast('Encrypted file exported.');
}

async function promptImportAndDecrypt() {
  const enc = prompt('Paste encrypted payload or URL hash:');
  if(!enc) return;
  const m = enc.match(/#data=([^&]+)/);
  const payload = m ? decodeURIComponent(m[1]) : enc.trim();
  const pass = await promptPassphrase('Enter passphrase:');
  if(!pass) return;
  try { const data = await decryptReport(pass, payload); applyData(data); toast('Imported report decrypted'); }
  catch(err){ console.error(err); alert('Failed to decrypt: wrong passphrase or corrupted data.'); }
}

// --- Setup ---
const shareBtn = document.getElementById('btnShare');
if(shareBtn){ shareBtn.onclick = ()=>makeEncryptedShareLink(); }

window.addEventListener('load', ()=>{ setTimeout(()=>tryLoadFromHash(), 250); });

// Expose for debugging / manual use
window.encryptReport = encryptReport;
window.decryptReport = decryptReport;
window.makeEncryptedShareLink = makeEncryptedShareLink;
window.promptImportAndDecrypt = promptImportAndDecrypt;
window.exportEncryptedJSONToFile = exportEncryptedJSONToFile;

})();
</script>
