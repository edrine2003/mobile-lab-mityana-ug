<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ§ª Ongoing Tests â€“ Mobile Lab</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family: Arial,sans-serif; margin:0; padding:16px; background:#f1f5f9; }
#logoutBtn { position:fixed; top:16px; right:16px; background:#ef4444; color:#fff; padding:12px 16px; border:none; border-radius:999px; cursor:pointer; }
.order-card { background:#fff; border:1px solid #cbd5e1; border-radius:12px; padding:12px; margin-bottom:12px; }
h4 { margin:8px 0; color:#0369a1; }
table { width:100%; border-collapse:collapse; margin-top:6px; }
th,td { border:1px solid #cbd5e1; padding:6px; }
th { background:#e2e8f0; }
input.result-input { width:100%; padding:4px; }
button.complete { margin-top:10px; background:#22c55e; color:#fff; border:none; padding:8px 14px; border-radius:10px; cursor:pointer; }
</style>
</head>
<body>

<button id="logoutBtn">Logout</button>
<h2>ðŸ§ª Ongoing Tests</h2>
<div id="ordersCounter">Loading...</div>
<div id="ordersContainer"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY",
  authDomain: "mobile-lab-mityana-aeae2.firebaseapp.com",
  projectId: "mobile-lab-mityana-aeae2"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
const ordersContainer = document.getElementById("ordersContainer");
const ordersCounter = document.getElementById("ordersCounter");

// ðŸ” Admin authentication
auth.onAuthStateChanged(async user => {
  if (!user) {
    location.href = "login.html";
    return;
  }

  const snap = await db.collection("users").doc(user.uid).get();

  if (!snap.exists || snap.data().role !== "admin") {
    alert("Access denied");
    await auth.signOut();
    location.href = "login.html";
    return;
  }

  loadOngoing();
});

document.getElementById("logoutBtn").onclick = async () => {
  await auth.signOut();
  location.href = "login.html";
};

// ðŸ“¥ Load ongoing tests
async function loadOngoing() {
  try {
    const snap = await db.collection("orders")
      .where("status", "==", "ongoing")
      .orderBy("createdAt", "asc")
      .get();

    if (snap.empty) {
      ordersCounter.innerText = "No ongoing tests";
      ordersContainer.innerHTML = "";
      return;
    }

    ordersCounter.innerText = `Ongoing Tests: ${snap.size}`;
    ordersContainer.innerHTML = "";

    snap.forEach(doc => {
      const o = doc.data();
      const card = document.createElement("div");
      card.className = "order-card";

      let html = `
        <h4>Order ID: ${doc.id}</h4>
        <p><b>Name:</b> ${o.name || ""} | <b>Phone:</b> ${o.phone || ""}</p>
        <p><b>Tests:</b> ${o.tests || ""}</p>
      `;

      const tests = o.tests ? o.tests.split(",") : [];

      tests.forEach(t => {
        html += `
          <p><b>${t.trim()}</b></p>
          <textarea class="result-input" placeholder="Enter result for ${t.trim()}"></textarea>
        `;
      });

      html += `<button class="complete">Save & Complete</button>`;
      card.innerHTML = html;
      ordersContainer.appendChild(card);

      card.querySelector(".complete").onclick = async () => {

        const results = {};
        let hasEmpty = false;

        card.querySelectorAll(".result-input").forEach((el, i) => {
          const value = el.value.trim();
          if (!value) hasEmpty = true;
          results[tests[i].trim()] = value;
        });

        if (hasEmpty) {
          alert("Please enter all test results before completing.");
          return;
        }

        try {

          // ðŸ”¥ IMPORTANT: user_id MUST match rules
          await db.collection("results").doc(doc.id).set({
            order_id: doc.id,
            user_id: o.user_id, // MUST match orders field
            patient_email: o.email || "",
            results: results,
            status: "completed",
            uploaded_at: firebase.firestore.FieldValue.serverTimestamp()
          });

          await db.collection("orders").doc(doc.id).update({
            status: "completed"
          });

          alert("Results saved & test completed");
          loadOngoing();

        } catch (error) {
          console.error("Error saving results:", error);
          alert("Failed to save results. Check console.");
        }
      };
    });

  } catch (error) {
    console.error("Load error:", error);
    ordersCounter.innerText = "Error loading tests.";
  }
}
</script>


</body>
</html>
