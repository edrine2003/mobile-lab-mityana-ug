<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ§ª Ongoing Tests â€“ Mobile Lab</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body { font-family: Arial,sans-serif; margin:0; padding:16px; background:#f1f5f9; }
#logoutBtn { position:fixed; top:16px; right:16px; background:#ef4444; color:#fff; padding:12px 16px; border:none; border-radius:999px; cursor:pointer; }
.order-card { background:#fff; border:1px solid #cbd5e1; border-radius:12px; padding:16px; margin-bottom:16px; box-shadow:0 4px 10px rgba(0,0,0,0.05); }
h4 { margin:8px 0; color:#0369a1; }
input.result-input, textarea.result-input { width:100%; padding:6px; margin-top:4px; border-radius:6px; border:1px solid #cbd5e1; }
table { width:100%; border-collapse:collapse; margin-top:8px; }
th, td { border:1px solid #ccc; padding:6px; text-align:center; }
th { background:#e2e8f0; }
button.complete { margin-top:12px; background:#22c55e; color:#fff; border:none; padding:10px 16px; border-radius:10px; cursor:pointer; font-weight:bold; }
button.complete:hover { background:#16a34a; }
</style>
</head>
<body>

<button id="logoutBtn">Logout</button>
<h2>ðŸ§ª Ongoing Tests</h2>
<div id="ordersCounter">Loading...</div>
<div id="ordersContainer"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY",
  authDomain: "mobile-lab-mityana-aeae2.firebaseapp.com",
  projectId: "mobile-lab-mityana-aeae2"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
const ordersContainer = document.getElementById("ordersContainer");
const ordersCounter = document.getElementById("ordersCounter");

// Admin Authentication
auth.onAuthStateChanged(async user=>{
  if(!user) return location.href="login.html";
  const userDoc = await db.collection("users").doc(user.uid).get();
  if(!userDoc.exists || userDoc.data().role!=="admin"){
    alert("Access denied");
    await auth.signOut();
    location.href="login.html";
    return;
  }
  loadOngoing();
});

document.getElementById("logoutBtn").onclick = async ()=>{
  await auth.signOut();
  location.href="login.html";
};

// All test names (full list)
const allTests=[
"CBC â€“ Complete Blood Count","Blood Glucose","Blood Grouping","Bleeding & Clotting Test",
"malaria (b/s)","Electrolytes","Lipid Profile","Liver Function Test (LFT)","Kidney Function Test (RFT)",
"PSA","HCG Blood","Sickling Test","DNA","HIV","Hepatitis B","Hepatitis C","RPR / Syphilis","Gonorrhea Test",
"Chlamydia Test","Brucella Test","Urinalysis","Stool Analysis","H. Pylori Stool","Widal Stool","H. Pylori Serum",
"Pregnancy Test (hCG)","High Vaginal Swab","High Vaginal Swab C&S","Gram Staining","Widal Serum","Rheumatoid Factor"
];

async function loadOngoing(){
  try{
    const snap = await db.collection("orders")
      .where("status","==","ongoing")
      .orderBy("createdAt","asc").get();

    if(snap.empty){
      ordersCounter.innerText="No ongoing tests";
      ordersContainer.innerHTML="";
      return;
    }

    ordersCounter.innerText=`Ongoing Tests: ${snap.size}`;
    ordersContainer.innerHTML="";

    snap.forEach(doc=>{
      const o=doc.data();
      if(!o.userId) return;

      const card=document.createElement("div");
      card.className="order-card";

      let html=`<h4>Order ID: ${doc.id}</h4>
        <p><b>Name:</b> ${o.name||""}</p>
        <p><b>Age:</b> ${o.age||""}</p>
        <p><b>Phone:</b> ${o.phone||""}</p>
        <p><b>Email:</b> ${o.email||""}</p>`;

      const tests=o.tests? o.tests.split(/,(?=\D)/): allTests;

      tests.forEach(test=>{
        const t=test.trim();

        // CBC Table
        if(t==="CBC â€“ Complete Blood Count"){
          html+=`<p><b>${t}</b></p>
          <table id="cbc-${doc.id}">
            <thead><tr><th>#</th><th>Parameter</th><th>Units</th><th>Result</th><th>Range</th></tr></thead>
            <tbody>
            ${["WBC","RBC","Hemoglobin","Hematocrit","MCV","MCH","MCHC","Platelets"].map((p,i)=>`
              <tr>
                <td>${i+1}</td><td>${p}</td>
                <td><input class="result-input" placeholder="Units"></td>
                <td><input class="result-input" placeholder="Result"></td>
                <td><input class="result-input" placeholder="Range"></td>
              </tr>`).join('')}
            </tbody>
          </table>`;
        }

        // Urinalysis Table
        else if(t==="Urinalysis"){
          html+=`<p><b>${t}</b></p>
          <table id="urine-${doc.id}">
            <thead><tr><th>#</th><th>Parameter</th><th>Result</th><th>Units</th><th>Range</th></tr></thead>
            <tbody>
            ${["Macroscopy","UROBILINOGEN","BILIRUBIN","SPECIFIC GRAVITY","pH","NITRITES","GLUCOSE","PROTEINS","KETONES","LEUKOCYTES","RBCs","Microscopy"].map((p,i)=>`
              <tr>
                <td>${i+1}</td><td>${p}</td>
                <td><input class="result-input" placeholder="Result"></td>
                <td><input class="result-input" placeholder="Units"></td>
                <td><input class="result-input" placeholder="Range"></td>
              </tr>`).join('')}
            </tbody>
          </table>`;
        }

        // All other tests editable
        else{
          html+=`<p><b>${t}</b></p>
                 <input type="text" class="result-input" placeholder="Enter result for ${t}">`;
        }
      });

      html+=`<button class="complete">Save & Complete & Generate PDF</button>`;
      card.innerHTML=html;
      ordersContainer.appendChild(card);

      // Button click
      card.querySelector(".complete").onclick=async ()=>{
        const results={};
        let hasEmpty=false;

        // CBC
        const cbcRows=card.querySelectorAll(`#cbc-${doc.id} tbody tr`);
        if(cbcRows.length>0){
          results["CBC â€“ Complete Blood Count"]=Array.from(cbcRows).map(r=>{
            const cells=r.querySelectorAll("input");
            if(!cells[1].value||!cells[2].value) hasEmpty=true;
            return { test: r.cells[1].innerText, units: cells[0].value, result: cells[1].value, range: cells[2].value };
          });
        }

        // Urinalysis
        const urineRows=card.querySelectorAll(`#urine-${doc.id} tbody tr`);
        if(urineRows.length>0){
          results["Urinalysis"]=Array.from(urineRows).map(r=>{
            const cells=r.querySelectorAll("input");
            if(!cells[0].value||!cells[1].value) hasEmpty=true;
            return { test: r.cells[1].innerText, result: cells[0].value, units: cells[1].value, range: cells[2].value };
          });
        }

        // Other inputs
        const otherInputs=card.querySelectorAll("input.result-input:not([type=hidden])");
        otherInputs.forEach((el)=>{
          const label=el.previousSibling?.textContent||"Other Test";
          if(!el.value) hasEmpty=true;
          results[label]=el.value.trim();
        });

        if(hasEmpty){
          alert("Please fill all results.");
          return;
        }

        try{
          await db.collection("results").doc(doc.id).set({
            order_id: doc.id,
            userId: o.userId,
            patient_email: o.email||"",
            patient_name: o.name||"",
            patient_age: o.age||"",
            results: results,
            status:"completed",
            uploaded_at: firebase.firestore.FieldValue.serverTimestamp()
          });
          await db.collection("orders").doc(doc.id).update({ status:"completed" });
          alert("Results saved & PDF generated.");

          // PDF Generation
          const { jsPDF }=window.jspdf;
          const pdf=new jsPDF("p","mm","a4");
          let y=20;
          const logo=new Image();
          logo.src="logo.png";
          logo.onload=()=>{
            pdf.addImage(logo,"PNG",15,y,40,15);
            pdf.setFontSize(18);
            pdf.text("MOBILE LAB SERVICES",105,y+10,{align:"center"});
            y+=25;
            pdf.setFontSize(12);
            pdf.text("Mityana, Uganda",105,y,{align:"center"});
            y+=15;
            pdf.setFontSize(13);
            pdf.text(`Patient Name: ${o.name}`,20,y); y+=8;
            pdf.text(`Age: ${o.age||""}`,20,y); y+=8;
            pdf.text(`Email: ${o.email||""}`,20,y); y+=12;
            pdf.text("Results:",20,y); y+=8;
            pdf.setFontSize(11);

            Object.entries(results).forEach(([k,v])=>{
              pdf.setFontSize(12);
              pdf.setTextColor(14,165,233);
              pdf.text(k,20,y); y+=7;
              pdf.setFontSize(11);
              pdf.setTextColor(0);

              if(Array.isArray(v)){
                v.forEach((row,i)=>{
                  pdf.text(`${i+1}. ${row.test} - Result: ${row.result} ${row.units||''} (Range: ${row.range||''})`,20,y);
                  y+=7;
                  if(y>280){ pdf.addPage(); y=20; }
                });
              }else{
                pdf.text(`Result: ${v}`,20,y); y+=7;
                if(y>280){ pdf.addPage(); y=20; }
              }
            });

            y+=10;
            pdf.setDrawColor(0);
            pdf.line(20,y,100,y); y+=6;
            pdf.text("Laboratory Officer: Edrine Labtech",20,y); y+=12;
            pdf.text("Contact: +256763885073 | Email: edrinehero@gmail.com",20,y); y+=7;
            pdf.text("Welcome to Little Hearts Sanctuary Mobile Lab. We ensure accurate results promptly!",20,y);

            pdf.save(`Lab_Result_${doc.id}.pdf`);
            window.location.href="completed_tests.html";
          };
        }catch(err){
          console.error(err);
          alert("Failed to save results. Check console.");
        }
      };
    });

  }catch(err){
    console.error(err);
    ordersCounter.innerText="Error loading tests.";
  }
}
</script>

</body>
</html>
