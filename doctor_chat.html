<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ðŸ’¬ Admin Inbox</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{font-family:Arial;background:#f1f5f9;padding:20px;}
#patientsList{height:200px;overflow-y:auto;background:#fff;padding:10px;border-radius:12px;margin-bottom:10px;}
#chatBox{height:400px;overflow-y:auto;background:#fff;padding:10px;border-radius:12px;margin-bottom:10px;}
.message{padding:6px 10px;margin:5px 0;border-radius:12px;max-width:70%;}
.sent{background:#0ea5e9;color:#fff;margin-left:auto;}
.received{background:#e2e8f0;margin-right:auto;}
.patientItem{padding:6px;border-bottom:1px solid #eee;cursor:pointer;}
.patientItem:hover{background:#e0f2fe;}
</style>
</head>
<body>

<h2>ðŸ’¬ Admin Inbox</h2>

<div id="patientsList"></div>
<div id="chatBox"></div>

<input type="text" id="msgInput" placeholder="Type reply">
<button id="sendBtn">Send</button>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY",
  authDomain: "mobile-lab-mityana-aeae2.firebaseapp.com",
  projectId: "mobile-lab-mityana-aeae2"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

const patientsList = document.getElementById("patientsList");
const chatBox = document.getElementById("chatBox");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");

let selectedChatId=null;

auth.onAuthStateChanged(admin=>{
  if(!admin) return location.href="login.html";

  db.collection("chats")
    .where("participants","array-contains",admin.uid)
    .orderBy("lastTimestamp","desc")
    .onSnapshot(snapshot=>{
      patientsList.innerHTML="";
      snapshot.forEach(doc=>{
        const chatId=doc.id;
        const data=doc.data();
        const patientUID=chatId.replace(admin.uid+"_","");

        const div=document.createElement("div");
        div.className="patientItem";
        div.innerHTML=`<b>${patientUID}</b><br><small>${data.lastMessage||""}</small>`;
        div.onclick=()=>openChat(chatId);
        patientsList.appendChild(div);
      });
    });
});

function openChat(chatId){
  selectedChatId=chatId;

  db.collection("chats")
    .doc(chatId)
    .collection("messages")
    .orderBy("timestamp")
    .onSnapshot(snapshot=>{
      chatBox.innerHTML="";
      snapshot.forEach(doc=>{
        const msg=doc.data();
        const div=document.createElement("div");
        div.className="message "+
          (msg.senderId===auth.currentUser.uid?"sent":"received");
        div.innerText=msg.text;
        chatBox.appendChild(div);
      });
      chatBox.scrollTop=chatBox.scrollHeight;
    });
}

sendBtn.onclick=async()=>{
  if(!selectedChatId) return alert("Select patient first");

  const text=msgInput.value.trim();
  if(!text) return;

  const chatRef=db.collection("chats").doc(selectedChatId);

  await chatRef.update({
    lastMessage:text,
    lastTimestamp:firebase.firestore.FieldValue.serverTimestamp()
  });

  await chatRef.collection("messages").add({
    senderId:auth.currentUser.uid,
    text:text,
    timestamp:firebase.firestore.FieldValue.serverTimestamp(),
    status:"unread"
  });

  msgInput.value="";
};
</script>

</body>
</html>
