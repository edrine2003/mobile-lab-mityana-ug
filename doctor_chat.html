<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Doctor Inbox ‚Äì Mobile Lab</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{font-family:Arial;background:#f4f6f9;margin:0;padding:20px;}
.patient{padding:10px;background:white;margin-bottom:10px;border-radius:8px;cursor:pointer;}
.chat{background:white;padding:10px;border-radius:8px;height:50vh;overflow-y:auto;}
</style>
</head>

<body>

<h2>üë®‚Äç‚öï Doctor Chat Dashboard</h2>

<div id="patients"></div>

<h3 id="chatTitle"></h3>
<div class="chat" id="chatBox"></div>
<br>
<input type="text" id="replyInput" placeholder="Reply...">
<button onclick="sendReply()">Send</button>

<script>

const firebaseConfig = {
  apiKey: "AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY",
  authDomain: "mobile-lab-mityana-aeae2.firebaseapp.com",
  projectId: "mobile-lab-mityana-aeae2"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let selectedPatient = null;
let doctorUser = null;

// AUTH
auth.onAuthStateChanged(async user=>{
  if(!user) return;

  doctorUser = user;
  loadPatients();
});

// LOAD PATIENTS
function loadPatients(){

  db.collection("chats").onSnapshot(snapshot=>{
    const container = document.getElementById("patients");
    container.innerHTML="";

    snapshot.forEach(doc=>{
      const patientId = doc.id;

      db.collection("users").doc(patientId).get().then(userDoc=>{
        const userData = userDoc.data();

        const div = document.createElement("div");
        div.className="patient";
        div.innerHTML = "üë§ "+userData.fullName;
        div.onclick = ()=> openChat(patientId,userData.fullName);
        container.appendChild(div);
      });
    });
  });
}

// OPEN CHAT
function openChat(patientId,name){
  selectedPatient = patientId;
  document.getElementById("chatTitle").innerText="Chat with "+name;

  db.collection("chats")
    .doc(patientId)
    .collection("messages")
    .orderBy("timestamp")
    .onSnapshot(snapshot=>{
      const box=document.getElementById("chatBox");
      box.innerHTML="";

      snapshot.forEach(doc=>{
        const data=doc.data();
        box.innerHTML += "<p><b>"+data.senderName+"</b>: "+data.text+"</p>";
      });

      box.scrollTop=box.scrollHeight;
    });
}

// SEND REPLY
async function sendReply(){

  const text=document.getElementById("replyInput").value;
  if(!text || !selectedPatient) return;

  await db.collection("chats")
    .doc(selectedPatient)
    .collection("messages")
    .add({
      text:text,
      senderId:doctorUser.uid,
      senderName:"Doctor",
      patientId:selectedPatient,
      receiverId:selectedPatient,
      timestamp:firebase.firestore.FieldValue.serverTimestamp(),
      status:"read"
    });

  document.getElementById("replyInput").value="";
}

</script>

</body>
</html>
