<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobile Lab â€“ Mityana Registration</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#0284c7,#0ea5e9);
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.card{
  width:100%;
  max-width:600px;
  background:white;
  padding:30px;
  border-radius:20px;
  box-shadow:0 25px 60px rgba(0,0,0,0.2);
}
h2{text-align:center;margin-bottom:5px;}
.subtitle{text-align:center;color:#666;font-size:14px;margin-bottom:15px;}
input,select{
  width:100%;
  padding:12px;
  margin:6px 0 14px;
  border-radius:10px;
  border:1px solid #ccc;
}
input:focus,select:focus{
  border-color:#0ea5e9;
  outline:none;
}
button{
  width:100%;
  padding:14px;
  background:#0ea5e9;
  border:none;
  color:white;
  font-weight:bold;
  border-radius:10px;
  cursor:pointer;
}
button:hover{background:#0284c7;}
.note{
  font-size:13px;
  background:#e0f2fe;
  padding:10px;
  border-radius:8px;
  margin-bottom:15px;
}
.checkbox{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:15px;
}
#msg{text-align:center;font-weight:bold;}
</style>
</head>
<body>

<div class="card">

<h2>ðŸ§ª Mobile Lab Registration</h2>
<div class="subtitle">Serving Mityana District Only</div>

<div class="note">
ðŸ“± Please register using a WhatsApp number for faster communication.
</div>

<form id="registerForm">

<input type="text" id="fullName" placeholder="Full Name" required>
<input type="email" id="email" placeholder="Email" required>
<input type="text" id="phone" placeholder="Phone (07XXXXXXXX)" required>

<select id="nationality" required>
<option value="">Nationality</option>
<option>Ugandan</option>
<option>Other</option>
</select>

<label>Date of Birth</label>
<input type="date" id="dob" required>
<input type="number" id="age" placeholder="Age (Auto)" readonly>

<input type="text" value="Mityana District" readonly>

<select id="subcounty" required>
<option value="">Select Subcounty</option>
<option value="Mityana Town Council">Mityana Town Council</option>
<option value="Busunju">Busunju</option>
<option value="Bulera">Bulera</option>
<option value="Kikandwa">Kikandwa</option>
<option value="Malangala">Malangala</option>
</select>

<select id="parish" required>
<option value="">Select Parish</option>
</select>

<input type="date" id="pickupDate" required>
<input type="time" id="pickupTime" required>

<div class="checkbox">
<input type="checkbox" id="emergency">
<label for="emergency">Emergency Case</label>
</div>

<label>Profile Picture (Optional)</label>
<input type="file" id="profilePic" accept="image/*">

<input type="password" id="password" placeholder="Password (min 6 characters)" required>

<button type="submit">Create Account</button>

<p id="msg"></p>

</form>
</div>

<script>
const firebaseConfig={
  apiKey:"YOUR_KEY",
  authDomain:"YOUR_DOMAIN",
  projectId:"YOUR_PROJECT_ID",
  storageBucket:"YOUR_STORAGE_BUCKET"
};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.firestore();
const storage=firebase.storage();

const dob=document.getElementById("dob");
const age=document.getElementById("age");
dob.addEventListener("change",()=>{
  const birth=new Date(dob.value);
  const diff=Date.now()-birth.getTime();
  const ageDate=new Date(diff);
  age.value=Math.abs(ageDate.getUTCFullYear()-1970);
});

const parishData={
"Mityana Town Council":["Central","Nakibanga","Ttamu"],
"Busunju":["Busunju Central","Kasaalu"],
"Bulera":["Bulera","Kigalama"],
"Kikandwa":["Kikandwa","Kisita"],
"Malangala":["Malangala","Kibibi"]
};

const subcounty=document.getElementById("subcounty");
const parish=document.getElementById("parish");

subcounty.addEventListener("change",()=>{
  parish.innerHTML="<option value=''>Select Parish</option>";
  parishData[subcounty.value]?.forEach(p=>{
    parish.innerHTML+=`<option>${p}</option>`;
  });
});

function generatePatientID(){
  return "MLM-"+Math.floor(100000+Math.random()*900000);
}

document.getElementById("registerForm").onsubmit=async(e)=>{
e.preventDefault();

try{
const name=fullName.value.trim();
const email=email.value.trim();
const phone=phone.value.trim();
const nationality=nationality.value;
const sub=subcounty.value;
const par=parish.value;
const emergency=emergency.checked;
const pickupDate=pickupDate.value;
const pickupTime=pickupTime.value;
const password=password.value;

if(!/^07[0-9]{8}$/.test(phone))
throw new Error("Use valid Ugandan number");

const userCred=await auth.createUserWithEmailAndPassword(email,password);
const uid=userCred.user.uid;

let photoURL="";
const file=document.getElementById("profilePic").files[0];
if(file){
  const ref=storage.ref("profiles/"+uid);
  await ref.put(file);
  photoURL=await ref.getDownloadURL();
}

navigator.geolocation.getCurrentPosition(async(pos)=>{
  const patientID=generatePatientID();

  await db.collection("users").doc(uid).set({
    patientID,
    fullName:name,
    email,
    phone,
    nationality,
    dob:dob.value,
    age:age.value,
    district:"Mityana District",
    subcounty:sub,
    parish:par,
    emergency,
    pickupDate,
    pickupTime,
    photoURL,
    latitude:pos.coords.latitude,
    longitude:pos.coords.longitude,
    role:"user",
    created_at:firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("Registration successful!");
  window.location.href="login.html";
});

}catch(err){
msg.style.color="red";
msg.innerText=err.message;
}
};
</script>

</body>
</html>
