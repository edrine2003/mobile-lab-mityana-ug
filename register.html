<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobile Lab â€“ Mityana Registration</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#0284c7,#0ea5e9);
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.card{
  width:100%;
  max-width:600px;
  background:white;
  padding:30px;
  border-radius:20px;
  box-shadow:0 25px 60px rgba(0,0,0,0.2);
}
h2{text-align:center;margin-bottom:5px;}
.subtitle{text-align:center;color:#666;font-size:14px;margin-bottom:15px;}
input,select{
  width:100%;
  padding:12px;
  margin:6px 0 14px;
  border-radius:10px;
  border:1px solid #ccc;
}
input:focus,select:focus{
  border-color:#0ea5e9;
  outline:none;
}
button{
  width:100%;
  padding:14px;
  background:#0ea5e9;
  border:none;
  color:white;
  font-weight:bold;
  border-radius:10px;
  cursor:pointer;
}
button:hover{background:#0284c7;}
.note{
  font-size:13px;
  background:#e0f2fe;
  padding:10px;
  border-radius:8px;
  margin-bottom:15px;
}
.checkbox{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:15px;
}
#msg{text-align:center;font-weight:bold;margin-top:10px;}
</style>
</head>
<body>

<div class="card">

<h2>ðŸ§ª Mobile Lab Registration</h2>
<div class="subtitle">Serving Mityana District Only</div>

<div class="note">
ðŸ“± Please register using a WhatsApp number for faster communication.
</div>

<form id="registerForm">

<input type="text" id="fullName" placeholder="Full Name" required>
<input type="email" id="email" placeholder="Email" required>
<input type="text" id="phone" placeholder="Phone (07XXXXXXXX)" required>

<select id="nationality" required>
<option value="">Nationality</option>
<option>Ugandan</option>
<option>Other</option>
</select>

<label>Date of Birth</label>
<input type="date" id="dob" required>
<input type="number" id="age" placeholder="Age (Auto)" readonly>

<input type="text" value="Mityana District" readonly>

<select id="subcounty" required>
<option value="">Select Subcounty</option>
<option value="Mityana Town Council">Mityana Town Council</option>
<option value="Busunju">Busunju</option>
<option value="Bulera">Bulera</option>
<option value="Kikandwa">Kikandwa</option>
<option value="Malangala">Malangala</option>
</select>

<select id="parish" required>
<option value="">Select Parish</option>
</select>

<input type="date" id="pickupDate" required>
<input type="time" id="pickupTime" required>

<div class="checkbox">
<input type="checkbox" id="emergency">
<label for="emergency">Emergency Case</label>
</div>

<label>Profile Picture (Optional)</label>
<input type="file" id="profilePic" accept="image/*">

<input type="password" id="password" placeholder="Password (min 6 characters)" required>

<button type="submit">Create Account</button>

<p id="msg"></p>

</form>
</div>

<script>

// âœ… YOUR REAL FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY",
  authDomain: "mobile-lab-mityana-aeae2.firebaseapp.com",
  projectId: "mobile-lab-mityana-aeae2",
  storageBucket: "mobile-lab-mityana-aeae2.firebasestorage.app",
  messagingSenderId: "624002906588",
  appId: "1:624002906588:web:08b4259f90ffa9adad7719",
  measurementId: "G-RWW6TCR0CD"
};

firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.firestore();
const storage=firebase.storage();
const msg=document.getElementById("msg");

// Auto Age Calculation
const dobInput=document.getElementById("dob");
const ageInput=document.getElementById("age");

dobInput.addEventListener("change",()=>{
  const birth=new Date(dobInput.value);
  const diff=Date.now()-birth.getTime();
  const ageDate=new Date(diff);
  ageInput.value=Math.abs(ageDate.getUTCFullYear()-1970);
});

// Parish dropdown
const parishData={
"Mityana Town Council":["Central","Nakibanga","Ttamu"],
"Busunju":["Busunju Central","Kasaalu"],
"Bulera":["Bulera","Kigalama"],
"Kikandwa":["Kikandwa","Kisita"],
"Malangala":["Malangala","Kibibi"]
};

const subcounty=document.getElementById("subcounty");
const parish=document.getElementById("parish");

subcounty.addEventListener("change",()=>{
  parish.innerHTML="<option value=''>Select Parish</option>";
  parishData[subcounty.value]?.forEach(p=>{
    parish.innerHTML+=`<option>${p}</option>`;
  });
});

function generatePatientID(){
  return "MLM-"+Math.floor(100000+Math.random()*900000);
}

document.getElementById("registerForm").onsubmit=async(e)=>{
e.preventDefault();
msg.style.color="red";
msg.innerText="";

try{

const fullName=document.getElementById("fullName").value.trim();
const userEmail=document.getElementById("email").value.trim();
const phone=document.getElementById("phone").value.trim();
const nationality=document.getElementById("nationality").value;
const sub=subcounty.value;
const par=parish.value;
const emergency=document.getElementById("emergency").checked;
const pickupDate=document.getElementById("pickupDate").value;
const pickupTime=document.getElementById("pickupTime").value;
const password=document.getElementById("password").value;

if(!/^07[0-9]{8}$/.test(phone))
throw new Error("Use valid Ugandan number (07XXXXXXXX)");

if(password.length<6)
throw new Error("Password must be at least 6 characters");

const userCred=await auth.createUserWithEmailAndPassword(userEmail,password);
const uid=userCred.user.uid;

let photoURL="";
const file=document.getElementById("profilePic").files[0];
if(file){
  const ref=storage.ref("profiles/"+uid);
  await ref.put(file);
  photoURL=await ref.getDownloadURL();
}

// GPS
navigator.geolocation.getCurrentPosition(async(pos)=>{

await db.collection("users").doc(uid).set({
  patientID:generatePatientID(),
  fullName,
  email:userEmail,
  phone,
  nationality,
  dob:dobInput.value,
  age:ageInput.value,
  district:"Mityana District",
  subcounty:sub,
  parish:par,
  emergency,
  pickupDate,
  pickupTime,
  photoURL,
  latitude:pos.coords.latitude,
  longitude:pos.coords.longitude,
  role:"user",
  created_at:firebase.firestore.FieldValue.serverTimestamp()
});

msg.style.color="green";
msg.innerText="Registration successful!";
setTimeout(()=>window.location.href="login.html",1500);

},()=>{
msg.innerText="Please allow GPS location.";
});

}catch(err){
msg.innerText=err.message;
}

};

</script>

</body>
</html>
