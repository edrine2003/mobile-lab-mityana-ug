<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ§ª New Requests â€“ Mobile Lab</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family: Arial,sans-serif; background:#f1f5f9; margin:0; padding:16px; }
h2 { text-align:center; margin-bottom:16px; }

#logoutBtn {
  position: fixed;
  top:16px;
  right:16px;
  background:#ef4444;
  color:#fff;
  border:none;
  padding:10px 14px;
  border-radius:999px;
  cursor:pointer;
}

table { width:100%; border-collapse: collapse; background:#fff; }
th,td { border:1px solid #cbd5e1; padding:8px; text-align:left; }
th { background:#e2e8f0; }

button.start { background:#22c55e; color:#fff; }
button.cancel { background:#ef4444; color:#fff; }

button { padding:6px 10px; border:none; border-radius:8px; cursor:pointer; margin-right:4px; }

/* ðŸ”€ ADMIN NAV BUTTONS (ADDED ONLY) */
.admin-nav{
  display:flex;
  gap:10px;
  justify-content:center;
  margin:20px 0;
}

.admin-nav button{
  padding:10px 16px;
  border:none;
  border-radius:999px;
  cursor:pointer;
  background:#e5e7eb;
  font-weight:600;
}

.admin-nav button.active{
  background:#0ea5e9;
  color:white;
}
</style>
</head>
<body>

<button id="logoutBtn">Logout</button>

<h2>ðŸ§ª Pending Requests</h2>

<!-- ðŸ”€ NAVIGATION BUTTONS (ADDED ONLY) -->
<div class="admin-nav">
  <button class="active">Pending</button>
  <button onclick="goPage('ongoing_tests.html')">Ongoing Tests</button>
  <button onclick="goPage('completed_tests.html')">Completed Tests</button>
</div>

<table>
<thead>
<tr>
  <th>#</th>
  <th>Time</th>
  <th>Order ID</th>
  <th>Client</th>
  <th>Tests</th>
  <th>Actions</th>
</tr>
</thead>
<tbody id="requestsTable">
<tr><td colspan="6">Loading...</td></tr>
</tbody>
</table>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY",
  authDomain:"mobile-lab-mityana-aeae2.firebaseapp.com",
  projectId:"mobile-lab-mityana-aeae2"
};

if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
const tableBody = document.getElementById("requestsTable");


// ðŸ” ADMIN AUTH CHECK
auth.onAuthStateChanged(async user => {
  if(!user){
    window.location.href="login.html";
    return;
  }

  const snap = await db.collection("users").doc(user.uid).get();
  if(!snap.exists || snap.data().role !== "admin"){
    alert("Access denied");
    await auth.signOut();
    window.location.href="login.html";
    return;
  }

  loadPending();
});

document.getElementById("logoutBtn").onclick = async ()=>{
  await auth.signOut();
  window.location.href="login.html";
};


// ðŸ“¥ LOAD ONLY PENDING
async function loadPending(){

  const snapshot = await db.collection("orders")
    .where("status","==","pending")
    .orderBy("createdAt","asc")
    .get();

  if(snapshot.empty){
    tableBody.innerHTML =
      `<tr><td colspan="6">No pending requests</td></tr>`;
    return;
  }

  tableBody.innerHTML = "";
  let count = 1;

  snapshot.forEach(doc=>{
    const o = doc.data();

    const testsCount = o.tests
      ? o.tests.split("|").length
      : 0;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${count++}</td>
      <td>${o.createdAt?.toDate().toLocaleString() || "â€”"}</td>
      <td>${doc.id}</td>
      <td>${o.name || "â€”"}</td>
      <td>${testsCount}</td>
      <td>
        <button class="start">Start</button>
        <button class="cancel">Cancel</button>
      </td>
    `;

    tableBody.appendChild(tr);

    // â–¶ START TEST
    tr.querySelector(".start").onclick = async ()=>{

      await db.collection("orders").doc(doc.id).update({
        status:"ongoing"
      });

      window.location.href = "ongoing_tests.html";
    };

    // âŒ CANCEL TEST
    tr.querySelector(".cancel").onclick = async ()=>{
      if(!confirm("Cancel this request?")) return;

      await db.collection("orders").doc(doc.id).update({
        status:"cancelled"
      });

      loadPending();
    };

  });
}

/* ðŸ”€ PAGE NAV FUNCTION (ADDED ONLY) */
function goPage(page){
  window.location.href = page;
}
</script>

</body>
</html>
