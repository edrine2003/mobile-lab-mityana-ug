<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ§ª Admin Requests â€“ Mobile Lab</title>
<meta name="theme-color" content="#0ea5e9">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family: Arial,sans-serif; background:#f1f5f9; margin:0; padding:16px; }
h2 { text-align:center; margin-bottom:12px; }

#logoutBtn {
  position: fixed;
  top:16px;
  right:16px;
  background:#ef4444;
  color:#fff;
  border:none;
  padding:10px 14px;
  border-radius:999px;
  cursor:pointer;
}

.filters {
  text-align:center;
  margin-bottom:12px;
}
.filters button {
  margin:4px;
  padding:8px 14px;
  border:none;
  border-radius:20px;
  cursor:pointer;
  background:#e5e7eb;
}
.filters button.active {
  background:#0ea5e9;
  color:#fff;
}

table { width:100%; border-collapse: collapse; background:#fff; }
th,td { border:1px solid #cbd5e1; padding:8px; text-align:left; }
th { background:#e2e8f0; }

button.start { background:#22c55e; color:#fff; }
button.cancel { background:#ef4444; color:#fff; }
button.view { background:#6366f1; color:#fff; }

button { padding:6px 10px; border:none; border-radius:8px; cursor:pointer; margin-right:4px; }
</style>
</head>
<body>

<button id="logoutBtn">Logout</button>
<h2>ðŸ§ª Lab Requests</h2>

<div class="filters">
  <button onclick="setStatus('pending')" class="active" id="btn-pending">Pending</button>
  <button onclick="setStatus('ongoing')" id="btn-ongoing">Ongoing</button>
  <button onclick="setStatus('completed')" id="btn-completed">Completed</button>
</div>

<table>
<thead>
<tr>
  <th>#</th>
  <th>Request Time</th>
  <th>Order ID</th>
  <th>Client</th>
  <th>Visit</th>
  <th>No. Tests</th>
  <th>View Tests</th>
  <th>Actions</th>
</tr>
</thead>
<tbody id="requestsTable">
<tr><td colspan="8">Loadingâ€¦</td></tr>
</tbody>
</table>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY",
  authDomain:"mobile-lab-mityana-aeae2.firebaseapp.com",
  projectId:"mobile-lab-mityana-aeae2"
};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
const tableBody = document.getElementById("requestsTable");

let currentStatus = "pending";

// ðŸ” Admin check
auth.onAuthStateChanged(async user => {
  if(!user){
    window.location.href="login.html";
    return;
  }

  const snap = await db.collection("users").doc(user.uid).get();
  if(!snap.exists || snap.data().role !== "admin"){
    alert("Access denied");
    await auth.signOut();
    window.location.href="login.html";
    return;
  }

  loadRequests();
});

document.getElementById("logoutBtn").onclick = async ()=>{
  await auth.signOut();
  window.location.href="login.html";
};

// ðŸ” Status switch
function setStatus(status){
  currentStatus = status;
  document.querySelectorAll(".filters button").forEach(b=>b.classList.remove("active"));
  document.getElementById("btn-"+status).classList.add("active");
  loadRequests();
}

// ðŸ“¥ Load requests
async function loadRequests(){
  const snapshot = await db.collection("orders")
  .where("status", "==", currentStatus)
  .orderBy("createdAt", "desc") // âœ… EXACT match
  .get();

  if(snapshot.empty){
    tableBody.innerHTML = `<tr><td colspan="8">No ${currentStatus} requests</td></tr>`;
    return;
  }

  tableBody.innerHTML = "";
  let count = 1;

  snapshot.forEach(doc=>{
    const o = doc.data();
    const tests = o.tests ? o.tests.split(",") : [];

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${count++}</td>
      <td>${o.createdAt ? o.createdAt.toDate().toLocaleString() : "â€”"}</td>
      <td>${doc.id}</td>
      <td>${o.name || "â€”"}</td>
      <td>${o.visit_type || "Self"}</td>
      <td>${tests.length}</td>
      <td><button class="view">View</button></td>
      <td>
        ${currentStatus==="pending" ? `<button class="start">Start</button>` : ``}
        ${currentStatus!=="completed" ? `<button class="cancel">Cancel</button>` : ``}
      </td>
    `;

    tableBody.appendChild(tr);

    tr.querySelector(".view").onclick = ()=>{
      alert("Tests:\n\n" + tests.join("\n"));
    };

    if(currentStatus==="pending"){
      tr.querySelector(".start").onclick = async ()=>{
        await db.collection("orders").doc(doc.id).update({ status:"ongoing" });
        loadRequests();
      };
    }

    if(currentStatus!=="completed"){
      tr.querySelector(".cancel").onclick = async ()=>{
        if(!confirm("Cancel this request?")) return;
        await db.collection("orders").doc(doc.id).update({ status:"cancelled" });
        loadRequests();
      };
    }
  });
}
</script>

</body>
</html>
