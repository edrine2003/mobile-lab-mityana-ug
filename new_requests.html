<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ§ª New Requests â€“ Mobile Lab</title>
<meta name="theme-color" content="#0ea5e9">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family: Arial,sans-serif; background:#f1f5f9; margin:0; padding:16px; }
h2 { text-align:center; margin-bottom:16px; }
#logoutBtn {
  position: fixed;
  top:16px;
  right:16px;
  background:#ef4444;
  color:#fff;
  border:none;
  padding:12px 16px;
  border-radius:999px;
  cursor:pointer;
}
table { width:100%; border-collapse: collapse; margin-top:16px; background:#fff; }
th,td { border:1px solid #cbd5e1; padding:8px; text-align:left; }
th { background:#e2e8f0; }
button { padding:6px 12px; border:none; border-radius:8px; cursor:pointer; margin-right:6px; }
button.start { background:#22c55e; color:#fff; }
button.cancel { background:#ef4444; color:#fff; }
</style>
</head>
<body>

<button id="logoutBtn">Logout</button>
<h2>ðŸ§ª New Requests</h2>

<table>
  <thead>
    <tr>
      <th>#</th>
      <th>Request Time</th>
      <th>Order ID</th>
      <th>Client Name</th>
      <th>Visit Type</th>
      <th>No. of Tests</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="requestsTable">
    <tr><td colspan="7">Loading requests...</td></tr>
  </tbody>
</table>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyA4II_I1weZZGzP990t9UWJCXjuK932pdY",
  authDomain:"mobile-lab-mityana-aeae2.firebaseapp.com",
  projectId:"mobile-lab-mityana-aeae2"
};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
const tableBody = document.getElementById("requestsTable");

// ðŸ” Admin check
auth.onAuthStateChanged(async user => {
  if(!user){
    window.location.href="login.html";
    return;
  }

  const snap = await db.collection("users").doc(user.uid).get();
  if(!snap.exists || snap.data().role !== "admin"){
    alert("Access denied");
    await auth.signOut();
    window.location.href="login.html";
    return;
  }

  loadRequests();
});

document.getElementById("logoutBtn").onclick = async ()=>{
  await auth.signOut();
  window.location.href="login.html";
};

// ðŸ“¥ Load pending requests
<script>
async function loadRequests(){
  const snapshot = await db
    .collection("orders")
    .where("status", "==", "pending")
    .orderBy("createdAt", "asc")
    .get();

  if (snapshot.empty) {
    tableBody.innerHTML =
      `<tr><td colspan="7">No new requests</td></tr>`;
    return;
  }

  tableBody.innerHTML = "";
  let count = 1;

  snapshot.forEach(doc => {
    const order = doc.data();

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${count++}</td>
      <td>${order.createdAt?.toDate().toLocaleString() || "â€”"}</td>
      <td>${doc.id}</td>
      <td>${order.name || "â€”"}</td>
      <td>${order.visit_type || "Self"}</td>
      <td>${order.tests ? order.tests.split(",").length : 0}</td>
      <td>
        <button class="start">Start</button>
        <button class="cancel">Cancel</button>
      </td>
    `;

    tableBody.appendChild(tr);

    tr.querySelector(".start").onclick = async () => {
      await db.collection("orders").doc(doc.id).update({
        status: "ongoing"
      });
      loadRequests();
    };

    tr.querySelector(".cancel").onclick = async () => {
      if (!confirm("Cancel this request?")) return;
      await db.collection("orders").doc(doc.id).update({
        status: "cancelled"
      });
      loadRequests();
    };
  });
}
</script>
</body>
</html>
